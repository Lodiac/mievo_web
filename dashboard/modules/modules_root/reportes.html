<!-- modules/modules_root/reportes.html - VERSI√ìN B√ÅSICA -->
<div class="content-header">
    <h1 class="content-title">
        <i class="fas fa-chart-bar"></i> Reporte de Tiendas
    </h1>
    <p class="content-subtitle">Datos b√°sicos de tiendas del sistema</p>
</div>

<div class="reportes-container">
    <!-- Controles simples -->
    <div class="card">
        <div class="card-header">
            <h3><i class="fas fa-filter"></i> Filtros</h3>
        </div>
        <div class="card-body">
            <div class="filters-row">
                <div class="filter-item">
                    <label for="fecha-inicio">Fecha Inicio</label>
                    <input type="date" id="fecha-inicio" class="form-control">
                </div>
                
                <div class="filter-item">
                    <label for="fecha-fin">Fecha Fin</label>
                    <input type="date" id="fecha-fin" class="form-control">
                </div>
                
                <div class="filter-item">
                    <button id="generar-reporte" class="btn btn-primary">
                        <i class="fas fa-search"></i> Consultar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Resultados simples -->
    <div class="card" id="resultados-card" style="display: none;">
        <div class="card-header">
            <h3><i class="fas fa-table"></i> Resultados</h3>
            <div class="info">
                <span id="total-registros" class="badge">0 registros</span>
            </div>
        </div>
        <div class="card-body">
            <div id="loading" class="loading" style="display: none;">
                <div class="spinner"></div>
                <p>Cargando datos...</p>
            </div>
            
            <div id="datos-container">
                <!-- Los datos se mostrar√°n aqu√≠ -->
            </div>
        </div>
    </div>
</div>

<style>
.reportes-container {
    padding: 20px;
    max-width: 1200px;
    margin: 0 auto;
}

.card {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 20px;
    border: 1px solid #ddd;
}

.card-header {
    padding: 15px 20px;
    border-bottom: 1px solid #eee;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #f8f9fa;
}

.card-header h3 {
    margin: 0;
    color: #333;
    display: flex;
    align-items: center;
    gap: 8px;
}

.card-body {
    padding: 20px;
}

.filters-row {
    display: flex;
    gap: 20px;
    align-items: end;
    flex-wrap: wrap;
}

.filter-item {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.filter-item label {
    font-weight: 600;
    color: #555;
    font-size: 0.9rem;
}

.form-control {
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 0.95rem;
    min-width: 150px;
}

.form-control:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.95rem;
}

.btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.btn-primary {
    background-color: #007bff;
    color: white;
}

.btn-primary:hover:not(:disabled) {
    background-color: #0056b3;
}

.badge {
    background: #007bff;
    color: white;
    padding: 6px 12px;
    border-radius: 15px;
    font-size: 0.85rem;
    font-weight: 600;
}

.loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 40px;
    text-align: center;
}

.spinner {
    width: 40px;
    height: 40px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid #007bff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 15px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.datos-tabla {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
    font-size: 0.9rem;
}

.datos-tabla th,
.datos-tabla td {
    padding: 12px 8px;
    text-align: left;
    border-bottom: 1px solid #eee;
}

.datos-tabla th {
    background: #f8f9fa;
    font-weight: 600;
    color: #555;
    position: sticky;
    top: 0;
    z-index: 1;
}

.datos-tabla tbody tr:hover {
    background-color: #f8f9fa;
}

.datos-tabla tbody tr:nth-child(even) {
    background-color: #fafafa;
}

.tabla-container {
    max-height: 600px;
    overflow-y: auto;
    border: 1px solid #ddd;
    border-radius: 6px;
}

.error-message {
    background: #f8d7da;
    color: #721c24;
    padding: 15px;
    border-radius: 6px;
    border: 1px solid #f5c6cb;
}

.success-message {
    background: #d4edda;
    color: #155724;
    padding: 15px;
    border-radius: 6px;
    border: 1px solid #c3e6cb;
}

.info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}

.info-card {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 6px;
    text-align: center;
    border-left: 4px solid #007bff;
}

.info-card-value {
    font-size: 1.5rem;
    font-weight: bold;
    color: #333;
    margin-bottom: 5px;
}

.info-card-label {
    font-size: 0.9rem;
    color: #666;
}

/* Responsivo */
@media (max-width: 768px) {
    .filters-row {
        flex-direction: column;
        align-items: stretch;
    }
    
    .filter-item {
        width: 100%;
    }
    
    .form-control {
        min-width: auto;
    }
}
</style>

<script>
// DEBUGGING EXTREMO
console.log('üü¢ Script iniciando...');

// Funci√≥n principal que se ejecuta inmediatamente
function inicializarModulo() {
    console.log('üü¢ Inicializando m√≥dulo (sin esperar DOMContentLoaded)');
    
    try {
        console.log('üü¢ Iniciando m√≥dulo b√°sico de reportes');
        
        // Buscar elementos DOM con verificaci√≥n
        console.log('üîç Buscando elementos DOM...');
        
        const fechaInicio = document.getElementById('fecha-inicio');
        console.log('üìÖ fechaInicio:', fechaInicio ? '‚úÖ Encontrado' : '‚ùå NO encontrado');
        
        const fechaFin = document.getElementById('fecha-fin');
        console.log('üìÖ fechaFin:', fechaFin ? '‚úÖ Encontrado' : '‚ùå NO encontrado');
        
        const generarBtn = document.getElementById('generar-reporte');
        console.log('üîò generarBtn:', generarBtn ? '‚úÖ Encontrado' : '‚ùå NO encontrado');
        
        const resultadosCard = document.getElementById('resultados-card');
        console.log('üìã resultadosCard:', resultadosCard ? '‚úÖ Encontrado' : '‚ùå NO encontrado');
        
        const loading = document.getElementById('loading');
        console.log('‚è≥ loading:', loading ? '‚úÖ Encontrado' : '‚ùå NO encontrado');
        
        const datosContainer = document.getElementById('datos-container');
        console.log('üìä datosContainer:', datosContainer ? '‚úÖ Encontrado' : '‚ùå NO encontrado');
        
        const totalRegistros = document.getElementById('total-registros');
        console.log('üî¢ totalRegistros:', totalRegistros ? '‚úÖ Encontrado' : '‚ùå NO encontrado');
        
        // Verificar si todos los elementos est√°n presentes
        if (!fechaInicio || !fechaFin || !generarBtn || !resultadosCard || !loading || !datosContainer || !totalRegistros) {
            console.error('‚ùå FALTAN ELEMENTOS DOM');
            alert('Error: Faltan elementos en el DOM. Revisa la consola.');
            return;
        }
        
        console.log('‚úÖ Todos los elementos DOM encontrados');
        
        // Establecer fechas por defecto
        console.log('üìÖ Estableciendo fechas por defecto...');
        const hoy = new Date();
        const haceSemana = new Date();
        haceSemana.setDate(hoy.getDate() - 7);
        
        fechaFin.value = hoy.toISOString().split('T')[0];
        fechaInicio.value = haceSemana.toISOString().split('T')[0];
        console.log('üìÖ Fechas establecidas:', {
            inicio: fechaInicio.value,
            fin: fechaFin.value
        });
        
        // Variable para datos
        let datosActuales = null;
        
        // Funci√≥n principal simplificada
        async function consultarDatos() {
            console.log('üü¢ ===== INICIANDO CONSULTA =====');
            
            try {
                // Mostrar loading
                console.log('‚è≥ Mostrando loading...');
                resultadosCard.style.display = 'block';
                loading.style.display = 'flex';
                datosContainer.innerHTML = '';
                totalRegistros.textContent = '0 registros';
                
                // Deshabilitar bot√≥n
                console.log('üîò Deshabilitando bot√≥n...');
                generarBtn.disabled = true;
                generarBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Consultando...';
                
                // Verificar datos de sesi√≥n
                console.log('üë§ Verificando sesi√≥n...');
                const userUID = sessionStorage.getItem('userUID');
                const userRole = sessionStorage.getItem('userRole');
                
                console.log('üë§ Datos de sesi√≥n:', {
                    userUID: userUID ? '‚úÖ Presente' : '‚ùå Faltante',
                    userRole: userRole ? '‚úÖ Presente' : '‚ùå Faltante',
                    uid_value: userUID,
                    role_value: userRole
                });
                
                if (!userUID || !userRole) {
                    throw new Error('No se encontraron datos de sesi√≥n. UID: ' + userUID + ', Role: ' + userRole);
                }
                
                // Preparar datos
                const requestData = {
                    uid: userUID,
                    role: userRole,
                    fecha_inicio: fechaInicio.value,
                    fecha_fin: fechaFin.value
                };
                
                console.log('üì§ Request data preparado:', requestData);
                
                // Hacer petici√≥n
                console.log('üåê Enviando petici√≥n a ../api/generar_reporte.php...');
                
                const response = await fetch('../api/generar_reporte.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });
                
                console.log('üì° Response recibido:', {
                    status: response.status,
                    statusText: response.statusText,
                    ok: response.ok,
                    headers: Object.fromEntries(response.headers.entries())
                });
                
                // Obtener el texto de la respuesta primero
                const responseText = await response.text();
                console.log('üì• Response text (primeros 500 caracteres):', responseText.substring(0, 500));
                console.log('üì• Response text completo:', responseText);
                
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status} - ${response.statusText}\nRespuesta: ${responseText.substring(0, 200)}`);
                }
                
                // Intentar parsear como JSON
                let resultado;
                try {
                    console.log('üì• Intentando parsear como JSON...');
                    resultado = JSON.parse(responseText);
                    console.log('üì• JSON parseado exitosamente:', resultado);
                } catch (jsonError) {
                    console.error('‚ùå Error parseando JSON:', jsonError);
                    console.error('‚ùå Respuesta que caus√≥ el error:', responseText);
                    throw new Error(`La API devolvi√≥ HTML en lugar de JSON. Esto indica un error en el servidor PHP.\n\nRespuesta recibida: ${responseText.substring(0, 300)}`);
                }
                
                if (!resultado.success) {
                    throw new Error('Error del servidor: ' + (resultado.error || 'Error desconocido'));
                }
                
                // Mostrar datos
                console.log('üìä Datos recibidos:', {
                    cantidad: resultado.datos ? resultado.datos.length : 0,
                    periodo: resultado.periodo,
                    timestamp: resultado.timestamp
                });
                
                datosActuales = resultado.datos;
                mostrarDatos(datosActuales, resultado.periodo);
                
                console.log('‚úÖ ===== CONSULTA COMPLETADA =====');
                
            } catch (error) {
                console.error('‚ùå ===== ERROR EN CONSULTA =====');
                console.error('‚ùå Error:', error);
                console.error('‚ùå Stack:', error.stack);
                mostrarError(error.message);
            } finally {
                console.log('üîÑ Restaurando bot√≥n...');
                loading.style.display = 'none';
                generarBtn.disabled = false;
                generarBtn.innerHTML = '<i class="fas fa-search"></i> Consultar';
            }
        }
        
        // Funci√≥n para mostrar datos
        function mostrarDatos(datos, periodo) {
            console.log('üìä ===== MOSTRANDO DATOS =====');
            console.log('üìä Datos recibidos:', datos);
            console.log('üìä Cantidad:', datos ? datos.length : 0);
            
            if (!datos || datos.length === 0) {
                datosContainer.innerHTML = '<div class="error-message">‚ùå No se encontraron datos para el per√≠odo seleccionado.</div>';
                totalRegistros.textContent = '0 registros';
                return;
            }
            
            // Actualizar contador
            totalRegistros.textContent = `${datos.length} registros`;
            
            // Mostrar datos simples
            let html = `
                <div class="success-message">
                    <strong>‚úÖ Consulta exitosa</strong><br>
                    Per√≠odo: ${periodo.inicio} al ${periodo.fin}<br>
                    Registros: ${datos.length}
                </div>
                
                <h4>Primeros 5 registros:</h4>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                    <strong>Total de registros:</strong> ${datos.length}<br>
                    <strong>Tiendas √∫nicas:</strong> ${[...new Set(datos.map(d => d.id))].length}<br>
                    <strong>UIDs procesadores √∫nicos:</strong> ${[...new Set(datos.flatMap(d => d.uids_procesadores ? d.uids_procesadores.split(', ') : []))].length}
                </div>
                
                <div style="overflow-x: auto; max-height: 400px; border: 1px solid #ddd; border-radius: 6px;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
                        <thead style="background: #f8f9fa; position: sticky; top: 0;">
                            <tr>
                                <th style="padding: 10px; border-bottom: 1px solid #ddd; text-align: left;">ID</th>
                                <th style="padding: 10px; border-bottom: 1px solid #ddd; text-align: left;">Nombre Tienda</th>
                                <th style="padding: 10px; border-bottom: 1px solid #ddd; text-align: left;">Proveedor</th>
                                <th style="padding: 10px; border-bottom: 1px solid #ddd; text-align: left;">Servicio</th>
                                <th style="padding: 10px; border-bottom: 1px solid #ddd; text-align: left;">UIDs Procesadores</th>
                                <th style="padding: 10px; border-bottom: 1px solid #ddd; text-align: left;">Solicitudes</th>
                                <th style="padding: 10px; border-bottom: 1px solid #ddd; text-align: left;">Monto Total</th>
                                <th style="padding: 10px; border-bottom: 1px solid #ddd; text-align: left;">Completadas</th>
                                <th style="padding: 10px; border-bottom: 1px solid #ddd; text-align: left;">Rechazadas</th>
                                <th style="padding: 10px; border-bottom: 1px solid #ddd; text-align: left;">Canceladas</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${datos.slice(0, 20).map(fila => `
                                <tr style="border-bottom: 1px solid #eee;">
                                    <td style="padding: 8px;">${fila.id || '-'}</td>
                                    <td style="padding: 8px; font-weight: 600;">${fila.nombre_tienda || '-'}</td>
                                    <td style="padding: 8px;">${fila.proveedor || '-'}</td>
                                    <td style="padding: 8px;">${fila.tipo_servicio || '-'}</td>
                                    <td style="padding: 8px; font-family: monospace; font-size: 0.8rem; color: #007bff;">
                                        ${fila.uids_procesadores || 'Sin datos'}
                                    </td>
                                    <td style="padding: 8px; text-align: center;">${fila.total_solicitudes_tienda || 0}</td>
                                    <td style="padding: 8px; text-align: right; font-weight: 600;">
                                        ${parseFloat(fila.total_monto_tienda || 0).toLocaleString('es-MX', {minimumFractionDigits: 2})}
                                    </td>
                                    <td style="padding: 8px; text-align: center; color: #28a745;">${fila.total_completadas_tienda || 0}</td>
                                    <td style="padding: 8px; text-align: center; color: #dc3545;">${fila.total_rechazadas_tienda || 0}</td>
                                    <td style="padding: 8px; text-align: center; color: #ffc107;">${fila.total_canceladas_tienda || 0}</td>
                                </tr>
                            `).join('')}
                            ${datos.length > 20 ? `
                                <tr>
                                    <td colspan="10" style="padding: 15px; text-align: center; font-style: italic; background: #f8f9fa;">
                                        ... y ${datos.length - 20} registros m√°s
                                    </td>
                                </tr>
                            ` : ''}
                        </tbody>
                    </table>
                </div>
                
                <details style="margin-top: 20px;">
                    <summary style="cursor: pointer; padding: 10px; background: #f8f9fa; border-radius: 6px; font-weight: 600;">
                        Ver datos raw JSON (primeros 3 registros)
                    </summary>
                    <pre style="background: #f8f9fa; padding: 15px; border-radius: 6px; overflow-x: auto; font-size: 0.75rem; margin-top: 10px;">
${JSON.stringify(datos.slice(0, 3), null, 2)}
                    </pre>
                </details>
            `;
            
            datosContainer.innerHTML = html;
            console.log('‚úÖ Datos mostrados en pantalla');
        }
        
        // Funci√≥n para mostrar errores
        function mostrarError(mensaje) {
            console.log('‚ùå Mostrando error:', mensaje);
            datosContainer.innerHTML = `
                <div class="error-message">
                    <strong>‚ùå Error:</strong><br>
                    ${mensaje}
                </div>
            `;
            totalRegistros.textContent = '0 registros';
        }
        
        // AGREGAR EVENT LISTENER CON LOGGING
        console.log('üîó Agregando event listener al bot√≥n...');
        
        // Agregar listener
        generarBtn.addEventListener('click', function() {
            console.log('üü¢ ¬°CLICK DETECTADO EN EL BOT√ìN!');
            consultarDatos();
        });
        
        console.log('‚úÖ Event listener agregado');
        
        // Funci√≥n de debugging global
        window.debugReportes = function() {
            console.log('üîç ===== DEBUG REPORTES =====');
            console.log('üìä Datos actuales:', datosActuales);
            console.log('üìÖ Fechas:', {
                inicio: fechaInicio ? fechaInicio.value : 'No disponible',
                fin: fechaFin ? fechaFin.value : 'No disponible'
            });
            console.log('üë§ Sesi√≥n:', {
                uid: sessionStorage.getItem('userUID'),
                role: sessionStorage.getItem('userRole')
            });
            console.log('üîò Bot√≥n habilitado:', generarBtn ? !generarBtn.disabled : 'Bot√≥n no encontrado');
            return datosActuales;
        };
        
        // Funci√≥n de prueba del bot√≥n
        window.testButton = function() {
            console.log('üß™ Probando click program√°tico...');
            if (generarBtn) {
                generarBtn.click();
            } else {
                console.error('‚ùå Bot√≥n no encontrado');
            }
        };
        
        console.log('‚úÖ ===== M√ìDULO COMPLETAMENTE INICIALIZADO =====');
        console.log('üí° Comandos disponibles:');
        console.log('   - window.debugReportes() : Ver estado');
        console.log('   - window.testButton() : Probar bot√≥n');
        
        // Auto-test
        setTimeout(() => {
            console.log('üß™ Auto-test del m√≥dulo...');
            console.log('üîò Bot√≥n existe:', !!generarBtn);
            console.log('üîò Bot√≥n habilitado:', generarBtn ? !generarBtn.disabled : false);
            console.log('üìÖ Fechas configuradas:', fechaInicio ? fechaInicio.value : 'N/A', 'a', fechaFin ? fechaFin.value : 'N/A');
        }, 500);
        
    } catch (error) {
        console.error('üí• ERROR FATAL EN INICIALIZACI√ìN:', error);
        alert('Error fatal: ' + error.message);
    }
}

// Ejecutar inmediatamente o cuando el DOM est√© listo
if (document.readyState === 'loading') {
    console.log('üü° DOM a√∫n cargando, esperando...');
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üü¢ DOM cargado (v√≠a event)');
        inicializarModulo();
    });
} else {
    console.log('üü¢ DOM ya est√° listo, iniciando inmediatamente');
    // Usar setTimeout para asegurar que el HTML se haya renderizado
    setTimeout(inicializarModulo, 100);
}

console.log('üü¢ Script cargado completamente');
</script>
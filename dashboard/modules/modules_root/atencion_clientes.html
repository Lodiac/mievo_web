<!-- M√≥dulo de Atenci√≥n al Cliente V3.0 - Con gesti√≥n de Sicatel -->
<div class="card">
    <h2 class="content-title">
        <i class="fas fa-headset"></i> Asignaci√≥n de Atenci√≥n al Cliente
        <span class="subtitle">Sistema completo de asignaciones con capacidades Sicatel</span>
    </h2>
    
    <!-- Pesta√±as principales -->
    <div class="tabs-container">
        <div class="tabs-header">
            <button class="tab-btn active" data-tab="asignar">
                <i class="fas fa-plus-circle"></i> Asignar Atenci√≥n
            </button>
            <button class="tab-btn" data-tab="ver">
                <i class="fas fa-list"></i> Ver Asignaciones
            </button>
            <button class="tab-btn" data-tab="sicatel">
                <i class="fas fa-crown"></i> Gestionar Sicatel
            </button>
        </div>
        
        <div class="tabs-content">
            <!-- ==================== PESTA√ëA ASIGNAR ==================== -->
            <div class="tab-panel active" id="panel-asignar">
                <div class="asignar-panel">
                    <!-- Selector de tienda origen -->
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-building"></i> Selecciona la tienda que dar√° atenci√≥n:
                        </label>
                        <select id="tienda-origen-selector" class="form-select">
                            <option value="">Cargando tiendas...</option>
                        </select>
                        
                        <!-- Informaci√≥n de capacidades -->
                        <div id="capacidades-info" class="capacidades-card" style="display: none;">
                            <div class="capacidades-header">
                                <i class="fas fa-info-circle"></i>
                                <span>Capacidades de la tienda</span>
                            </div>
                            <div id="capacidades-content" class="capacidades-content">
                                Selecciona una tienda para ver sus capacidades
                            </div>
                        </div>
                    </div>
                    
                    <!-- Selector de tipo de asignaci√≥n -->
                    <div id="tipo-asignacion-section" class="form-group" style="display: none;">
                        <label class="form-label">
                            <i class="fas fa-route"></i> Tipo de asignaci√≥n:
                        </label>
                        <div class="tipo-buttons">
                            <button type="button" id="btn-tipo-internas" class="tipo-btn" disabled>
                                <div class="tipo-icon">
                                    <i class="fas fa-building"></i>
                                </div>
                                <div class="tipo-content">
                                    <span class="tipo-title">Tiendas Internas</span>
                                    <span class="tipo-subtitle">Requiere Sicatel üëë</span>
                                </div>
                            </button>
                            <button type="button" id="btn-tipo-externas" class="tipo-btn" disabled>
                                <div class="tipo-icon">
                                    <i class="fas fa-store"></i>
                                </div>
                                <div class="tipo-content">
                                    <span class="tipo-title">Tiendas Externas</span>
                                    <span class="tipo-subtitle">Disponible para todas</span>
                                </div>
                            </button>
                        </div>
                    </div>
                    
                    <!-- B√∫squeda de tiendas destino -->
                    <div id="busqueda-section" class="form-group" style="display: none;">
                        <label class="form-label">
                            <i class="fas fa-search"></i> Buscar tiendas destino:
                        </label>
                        <div class="search-controls">
                            <div class="search-input-wrapper">
                                <input type="text" id="search-destino" class="search-input" placeholder="Buscar tiendas...">
                                <i class="fas fa-search search-icon"></i>
                            </div>
                            <button id="btn-buscar-destino" class="btn btn-secondary">Buscar</button>
                            <button id="btn-limpiar-busqueda" class="btn btn-outline">Limpiar</button>
                        </div>
                    </div>
                    
                    <!-- Lista de tiendas destino -->
                    <div id="destino-container" style="display: none;">
                        <!-- Loading state -->
                        <div id="destino-loading" class="loading-state">
                            <div class="spinner"></div>
                            <span>Cargando tiendas destino...</span>
                        </div>
                        
                        <!-- Error state -->
                        <div id="destino-error" class="error-state" style="display: none;">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span id="destino-error-message">Error al cargar tiendas</span>
                        </div>
                        
                        <!-- Empty state -->
                        <div id="destino-empty" class="empty-state" style="display: none;">
                            <i class="fas fa-store-slash"></i>
                            <h3>No hay tiendas disponibles</h3>
                            <p id="destino-empty-message">No se encontraron tiendas para asignar</p>
                        </div>
                        
                        <!-- Lista de tiendas -->
                        <div id="destino-lista" style="display: none;">
                            <div class="lista-header">
                                <div class="seleccion-controls">
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="select-all-destino">
                                        <span>Seleccionar todas</span>
                                    </label>
                                    <span id="contador-seleccionadas" class="contador">0 seleccionadas</span>
                                </div>
                                <span id="tipo-actual" class="tipo-badge">Ning√∫n tipo</span>
                            </div>
                            
                            <div id="tiendas-tree" class="tiendas-tree">
                                <!-- Aqu√≠ se cargar√°n las tiendas din√°micamente -->
                            </div>
                            
                            <div class="action-section">
                                <button id="btn-asignar" class="btn btn-primary" disabled>
                                    <i class="fas fa-link"></i>
                                    Asignar tiendas seleccionadas
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ==================== PESTA√ëA VER ASIGNACIONES ==================== -->
            <div class="tab-panel" id="panel-ver">
                <!-- Estad√≠sticas -->
                <div id="asignaciones-stats" class="stats-grid" style="display: none;">
                    <div class="stat-card stat-total">
                        <div class="stat-icon"><i class="fas fa-tasks"></i></div>
                        <div class="stat-content">
                            <div class="stat-number" id="stat-total">0</div>
                            <div class="stat-label">Total</div>
                        </div>
                    </div>
                    <div class="stat-card stat-activas">
                        <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
                        <div class="stat-content">
                            <div class="stat-number" id="stat-activas">0</div>
                            <div class="stat-label">Activas</div>
                        </div>
                    </div>
                    <div class="stat-card stat-sicatel">
                        <div class="stat-icon"><i class="fas fa-crown"></i></div>
                        <div class="stat-content">
                            <div class="stat-number" id="stat-sicatel">0</div>
                            <div class="stat-label">Con Sicatel</div>
                        </div>
                    </div>
                    <div class="stat-card stat-tipos">
                        <div class="stat-icon"><i class="fas fa-exchange-alt"></i></div>
                        <div class="stat-content">
                            <div class="stat-number" id="stat-interna-interna">0</div>
                            <div class="stat-label">Interna ‚Üî Interna</div>
                        </div>
                    </div>
                </div>
                
                <!-- Controles de b√∫squeda -->
                <div class="search-controls">
                    <div class="search-input-wrapper">
                        <input type="text" id="search-asignaciones" class="search-input" placeholder="Buscar asignaciones...">
                        <i class="fas fa-search search-icon"></i>
                    </div>
                    <button id="btn-buscar-asignaciones" class="btn btn-secondary">Buscar</button>
                    <button id="btn-limpiar-asignaciones" class="btn btn-outline">Limpiar</button>
                </div>
                
                <!-- Estados de carga/error/vac√≠o -->
                <div id="asignaciones-loading" class="loading-state">
                    <div class="spinner"></div>
                    <span>Cargando asignaciones...</span>
                </div>
                
                <div id="asignaciones-error" class="error-state" style="display: none;">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span id="asignaciones-error-message">Error al cargar asignaciones</span>
                </div>
                
                <div id="asignaciones-empty" class="empty-state" style="display: none;">
                    <i class="fas fa-tasks"></i>
                    <h3>No hay asignaciones</h3>
                    <p>A√∫n no se han creado asignaciones de atenci√≥n</p>
                </div>
                
                <!-- Tabla de asignaciones -->
                <div id="asignaciones-table-container" style="display: none;">
                    <div class="table-wrapper">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Tienda Origen</th>
                                    <th>Tienda Destino</th>
                                    <th>Tipo Asignaci√≥n</th>
                                    <th>Fecha</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="asignaciones-tbody">
                                <!-- Filas se cargan din√°micamente -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Paginaci√≥n -->
                    <div id="asignaciones-pagination" class="pagination" style="display: none;">
                        <button id="asignaciones-prev" class="pagination-btn">
                            <i class="fas fa-chevron-left"></i> Anterior
                        </button>
                        <div id="asignaciones-pages" class="pagination-pages"></div>
                        <button id="asignaciones-next" class="pagination-btn">
                            Siguiente <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- ==================== PESTA√ëA GESTIONAR SICATEL ==================== -->
            <div class="tab-panel" id="panel-sicatel">
                <!-- Estad√≠sticas de Sicatel -->
                <div id="sicatel-stats" class="stats-grid" style="display: none;">
                    <div class="stat-card stat-sicatel-total">
                        <div class="stat-icon"><i class="fas fa-building"></i></div>
                        <div class="stat-content">
                            <div class="stat-number" id="sicatel-stat-total">0</div>
                            <div class="stat-label">Total Tiendas</div>
                        </div>
                    </div>
                    <div class="stat-card stat-sicatel-enabled">
                        <div class="stat-icon"><i class="fas fa-crown"></i></div>
                        <div class="stat-content">
                            <div class="stat-number" id="sicatel-stat-enabled">0</div>
                            <div class="stat-label">Con Sicatel</div>
                        </div>
                    </div>
                    <div class="stat-card stat-sicatel-disabled">
                        <div class="stat-icon"><i class="fas fa-store"></i></div>
                        <div class="stat-content">
                            <div class="stat-number" id="sicatel-stat-disabled">0</div>
                            <div class="stat-label">Sin Sicatel</div>
                        </div>
                    </div>
                    <div class="stat-card stat-sicatel-percent">
                        <div class="stat-icon"><i class="fas fa-percentage"></i></div>
                        <div class="stat-content">
                            <div class="stat-number" id="sicatel-stat-percent">0%</div>
                            <div class="stat-label">Cobertura</div>
                        </div>
                    </div>
                </div>
                
                <!-- Controles de gesti√≥n -->
                <div class="sicatel-controls">
                    <!-- B√∫squeda -->
                    <div class="search-controls">
                        <div class="search-input-wrapper">
                            <input type="text" id="search-sicatel" class="search-input" placeholder="Buscar tiendas internas...">
                            <i class="fas fa-search search-icon"></i>
                        </div>
                        <button id="btn-buscar-sicatel" class="btn btn-secondary">Buscar</button>
                        <button id="btn-limpiar-sicatel" class="btn btn-outline">Limpiar</button>
                    </div>
                    
                    <!-- Acciones masivas -->
                    <div class="bulk-actions">
                        <div class="bulk-selection">
                            <label class="checkbox-label">
                                <input type="checkbox" id="select-all-sicatel">
                                <span>Seleccionar todas</span>
                            </label>
                            <span id="contador-sicatel" class="contador">0 seleccionadas</span>
                        </div>
                        <div class="bulk-buttons">
                            <button id="btn-enable-bulk" class="btn btn-success" disabled>
                                <i class="fas fa-crown"></i> Habilitar Sicatel
                            </button>
                            <button id="btn-disable-bulk" class="btn btn-warning" disabled>
                                <i class="fas fa-times"></i> Deshabilitar Sicatel
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Estados de carga/error/vac√≠o -->
                <div id="sicatel-loading" class="loading-state">
                    <div class="spinner"></div>
                    <span>Cargando tiendas internas...</span>
                </div>
                
                <div id="sicatel-error" class="error-state" style="display: none;">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span id="sicatel-error-message">Error al cargar tiendas</span>
                </div>
                
                <div id="sicatel-empty" class="empty-state" style="display: none;">
                    <i class="fas fa-building"></i>
                    <h3>No hay tiendas internas</h3>
                    <p>No se encontraron tiendas internas para gestionar</p>
                </div>
                
                <!-- Tabla de gesti√≥n Sicatel -->
                <div id="sicatel-table-container" style="display: none;">
                    <div class="table-wrapper">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th width="40">
                                        <input type="checkbox" id="select-all-table-sicatel">
                                    </th>
                                    <th>Tienda</th>
                                    <th>Encargado</th>
                                    <th>Tipo</th>
                                    <th>Estado Sicatel</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="sicatel-tbody">
                                <!-- Filas se cargan din√°micamente -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Paginaci√≥n -->
                    <div id="sicatel-pagination" class="pagination" style="display: none;">
                        <button id="sicatel-prev" class="pagination-btn">
                            <i class="fas fa-chevron-left"></i> Anterior
                        </button>
                        <div id="sicatel-pages" class="pagination-pages"></div>
                        <button id="sicatel-next" class="pagination-btn">
                            Siguiente <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Estilos CSS -->
<style>
:root {
    --primary-color: #303498;
    --primary-dark: #282b7a;
    --success-color: #28a745;
    --warning-color: #ffc107;
    --danger-color: #dc3545;
    --info-color: #17a2b8;
    --sicatel-color: #ffd700;
    --light-bg: #f8f9fa;
    --border-color: #dee2e6;
    --text-primary: #333333;
    --text-secondary: #6c757d;
    --border-radius: 8px;
    --shadow: 0 2px 4px rgba(0,0,0,0.1);
    --transition: all 0.2s ease;
}

/* Layout principal */
.content-title {
    color: var(--primary-color) !important;
    margin-bottom: 10px;
}

.subtitle {
    display: block;
    font-size: 0.9rem;
    font-weight: normal;
    color: var(--text-secondary);
    margin-top: 5px;
}

/* Pesta√±as */
.tabs-container {
    margin-top: 20px;
}

.tabs-header {
    display: flex;
    border-bottom: 2px solid var(--border-color);
    margin-bottom: 30px;
    gap: 5px;
}

.tab-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 20px;
    background: none;
    border: none;
    border-bottom: 3px solid transparent;
    cursor: pointer;
    font-weight: 500;
    color: var(--text-secondary);
    transition: var(--transition);
    border-radius: var(--border-radius) var(--border-radius) 0 0;
}

.tab-btn:hover {
    color: var(--primary-color);
    background-color: var(--light-bg);
}

.tab-btn.active {
    color: var(--primary-color);
    border-bottom-color: var(--primary-color);
    background-color: white;
}

.tab-panel {
    display: none;
    animation: fadeIn 0.3s ease;
}

.tab-panel.active {
    display: block;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Formularios */
.form-group {
    margin-bottom: 25px;
}

.form-label {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 10px;
    font-weight: 600;
    color: var(--text-primary);
}

.form-select {
    width: 100%;
    max-width: 500px;
    padding: 12px 16px;
    border: 2px solid var(--border-color);
    border-radius: var(--border-radius);
    background: white;
    font-size: 1rem;
    transition: var(--transition);
}

.form-select:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(48, 52, 152, 0.1);
}

/* Capacidades card */
.capacidades-card {
    margin-top: 15px;
    padding: 15px;
    background: var(--light-bg);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    border-left: 4px solid var(--info-color);
}

.capacidades-header {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 600;
    color: var(--info-color);
    margin-bottom: 8px;
}

.capacidades-content {
    color: var(--text-primary);
    font-size: 0.95rem;
}

/* Botones de tipo */
.tipo-buttons {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 15px;
}

.tipo-btn {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 20px;
    border: 2px solid var(--border-color);
    border-radius: var(--border-radius);
    background: white;
    cursor: pointer;
    transition: var(--transition);
    text-align: left;
}

.tipo-btn:hover:not(:disabled) {
    border-color: var(--primary-color);
    background: rgba(48, 52, 152, 0.05);
}

.tipo-btn.active {
    border-color: var(--primary-color);
    background: var(--primary-color);
    color: white;
}

.tipo-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    background: var(--light-bg);
}

.tipo-icon {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: var(--light-bg);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    color: var(--primary-color);
}

.tipo-btn.active .tipo-icon {
    background: rgba(255,255,255,0.2);
    color: white;
}

.tipo-content {
    flex: 1;
}

.tipo-title {
    display: block;
    font-weight: 600;
    font-size: 1.1rem;
    margin-bottom: 5px;
}

.tipo-subtitle {
    display: block;
    font-size: 0.9rem;
    opacity: 0.8;
}

/* Controles de b√∫squeda */
.search-controls {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.search-input-wrapper {
    position: relative;
    flex: 1;
    min-width: 250px;
}

.search-input {
    width: 100%;
    padding: 12px 16px 12px 45px;
    border: 2px solid var(--border-color);
    border-radius: var(--border-radius);
    font-size: 1rem;
    transition: var(--transition);
}

.search-input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(48, 52, 152, 0.1);
}

.search-icon {
    position: absolute;
    left: 15px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-secondary);
}

/* Botones */
.btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 12px 20px;
    border: 2px solid transparent;
    border-radius: var(--border-radius);
    font-weight: 500;
    cursor: pointer;
    transition: var(--transition);
    text-decoration: none;
    font-size: 0.95rem;
}

.btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.btn-primary {
    background: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
}

.btn-primary:hover:not(:disabled) {
    background: var(--primary-dark);
    border-color: var(--primary-dark);
}

.btn-secondary {
    background: var(--text-secondary);
    color: white;
    border-color: var(--text-secondary);
}

.btn-secondary:hover:not(:disabled) {
    background: #5a6268;
}

.btn-success {
    background: var(--success-color);
    color: white;
    border-color: var(--success-color);
}

.btn-success:hover:not(:disabled) {
    background: #218838;
}

.btn-warning {
    background: var(--warning-color);
    color: #212529;
    border-color: var(--warning-color);
}

.btn-warning:hover:not(:disabled) {
    background: #e0a800;
}

.btn-outline {
    background: transparent;
    color: var(--text-secondary);
    border-color: var(--border-color);
}

.btn-outline:hover:not(:disabled) {
    background: var(--light-bg);
}

/* Estados */
.loading-state {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 15px;
    padding: 40px;
    color: var(--text-secondary);
}

.spinner {
    width: 30px;
    height: 30px;
    border: 3px solid var(--border-color);
    border-top: 3px solid var(--primary-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.error-state {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    padding: 30px;
    color: var(--danger-color);
    background: #f8d7da;
    border: 1px solid #f5c6cb;
    border-radius: var(--border-radius);
}

.empty-state {
    text-align: center;
    padding: 40px;
    color: var(--text-secondary);
}

.empty-state i {
    font-size: 3rem;
    margin-bottom: 15px;
    opacity: 0.5;
}

.empty-state h3 {
    margin: 0 0 10px 0;
    color: var(--text-primary);
}

.empty-state p {
    margin: 0;
}

/* Estad√≠sticas */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: white;
    border-radius: var(--border-radius);
    padding: 20px;
    display: flex;
    align-items: center;
    gap: 15px;
    box-shadow: var(--shadow);
    border-left: 4px solid var(--primary-color);
}

.stat-card.stat-sicatel,
.stat-card.stat-sicatel-enabled {
    border-left-color: var(--sicatel-color);
}

.stat-card.stat-activas {
    border-left-color: var(--success-color);
}

.stat-card.stat-sicatel-disabled {
    border-left-color: var(--text-secondary);
}

.stat-icon {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: var(--primary-color);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.3rem;
}

.stat-sicatel .stat-icon,
.stat-sicatel-enabled .stat-icon {
    background: var(--sicatel-color);
    color: #333;
}

.stat-activas .stat-icon {
    background: var(--success-color);
}

.stat-sicatel-disabled .stat-icon {
    background: var(--text-secondary);
}

.stat-content {
    flex: 1;
}

.stat-number {
    font-size: 2rem;
    font-weight: bold;
    color: var(--text-primary);
    line-height: 1;
}

.stat-label {
    color: var(--text-secondary);
    font-size: 0.9rem;
}

/* Lista de tiendas */
.lista-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    background: var(--light-bg);
    border-radius: var(--border-radius);
    margin-bottom: 15px;
}

.seleccion-controls {
    display: flex;
    align-items: center;
    gap: 15px;
}

.checkbox-label {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    font-weight: 500;
}

.contador {
    background: var(--primary-color);
    color: white;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 500;
}

.tipo-badge {
    background: var(--info-color);
    color: white;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 500;
}

/* √Årbol de tiendas */
.tiendas-tree {
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    max-height: 400px;
    overflow-y: auto;
}

.tree-item {
    border-bottom: 1px solid var(--border-color);
}

.tree-item:last-child {
    border-bottom: none;
}

.tree-parent {
    display: flex;
    align-items: center;
    padding: 15px;
    background: white;
    cursor: pointer;
    transition: var(--transition);
}

.tree-parent:hover {
    background: var(--light-bg);
}

.tree-parent-content {
    display: flex;
    align-items: center;
    gap: 12px;
    flex: 1;
}

.tree-toggle {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: var(--border-color);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: var(--transition);
}

.tree-toggle:hover {
    background: var(--primary-color);
    color: white;
}

.tree-name {
    font-weight: 500;
    color: var(--text-primary);
}

.sicatel-crown {
    color: var(--sicatel-color);
    margin-left: 8px;
}

.tree-badge {
    background: var(--light-bg);
    color: var(--text-secondary);
    padding: 4px 8px;
    border-radius: 15px;
    font-size: 0.8rem;
}

.tree-children {
    display: none;
    background: #fafbfc;
    border-top: 1px solid var(--border-color);
}

.tree-children.expanded {
    display: block;
}

.tree-child {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 15px 12px 50px;
    border-bottom: 1px solid #f0f0f0;
}

.tree-child:last-child {
    border-bottom: none;
}

.tree-child-info {
    flex: 1;
}

.tree-child-name {
    font-weight: 500;
    color: var(--text-primary);
    display: block;
}

.tree-child-detail {
    color: var(--text-secondary);
    font-size: 0.85rem;
}

/* Secci√≥n de acciones */
.action-section {
    margin-top: 20px;
    text-align: center;
}

/* Tabla de datos */
.table-wrapper {
    overflow-x: auto;
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    background: white;
}

.data-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.95rem;
}

.data-table th,
.data-table td {
    padding: 12px 15px;
    text-align: left;
    border-bottom: 1px solid var(--border-color);
}

.data-table th {
    background: var(--light-bg);
    font-weight: 600;
    color: var(--text-primary);
    position: sticky;
    top: 0;
}

.data-table tr:hover {
    background: var(--light-bg);
}

.data-table tr:last-child td {
    border-bottom: none;
}

/* Badges de estado */
.status-badge {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 4px 10px;
    border-radius: 15px;
    font-size: 0.8rem;
    font-weight: 500;
}

.status-active {
    background: #d4edda;
    color: #155724;
}

.status-inactive {
    background: #f8d7da;
    color: #721c24;
}

.tipo-asignacion-badge {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 4px 10px;
    border-radius: 15px;
    font-size: 0.8rem;
    font-weight: 500;
}

.tipo-interna-interna {
    background: #cce5ff;
    color: #004085;
}

.tipo-interna-externa {
    background: #e2e3f5;
    color: #383d41;
}

.tipo-externa-interna {
    background: #d4edda;
    color: #155724;
}

/* Toggle switches */
.sicatel-toggle {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 26px;
}

.sicatel-toggle input {
    opacity: 0;
    width: 0;
    height: 0;
}

.sicatel-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: .4s;
    border-radius: 26px;
}

.sicatel-slider:before {
    position: absolute;
    content: "";
    height: 20px;
    width: 20px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
}

.sicatel-toggle input:checked + .sicatel-slider {
    background-color: var(--sicatel-color);
}

.sicatel-toggle input:checked + .sicatel-slider:before {
    transform: translateX(24px);
}

/* Controles masivos */
.sicatel-controls {
    background: var(--light-bg);
    border-radius: var(--border-radius);
    padding: 20px;
    margin-bottom: 20px;
}

.bulk-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 15px;
    flex-wrap: wrap;
    gap: 15px;
}

.bulk-selection {
    display: flex;
    align-items: center;
    gap: 15px;
}

.bulk-buttons {
    display: flex;
    gap: 10px;
}

/* Paginaci√≥n */
.pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
    margin-top: 20px;
}

.pagination-btn {
    display: flex;
    align-items: center;
    gap: 5px;
    padding: 8px 12px;
    background: white;
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    cursor: pointer;
    transition: var(--transition);
}

.pagination-btn:hover:not(:disabled) {
    background: var(--light-bg);
}

.pagination-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.pagination-pages {
    display: flex;
    gap: 5px;
}

.page-number {
    width: 35px;
    height: 35px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    cursor: pointer;
    transition: var(--transition);
    background: white;
}

.page-number:hover {
    background: var(--light-bg);
}

.page-number.active {
    background: var(--primary-color);
    border-color: var(--primary-color);
    color: white;
}

.page-ellipsis {
    padding: 8px;
    color: var(--text-secondary);
}

/* Botones de acci√≥n */
.btn-sm {
    padding: 6px 12px;
    font-size: 0.85rem;
}

.btn-danger {
    background: var(--danger-color);
    color: white;
    border-color: var(--danger-color);
}

.btn-danger:hover:not(:disabled) {
    background: #c82333;
}

/* Responsive */
@media (max-width: 768px) {
    .tabs-header {
        flex-wrap: wrap;
    }
    
    .search-controls {
        flex-direction: column;
    }
    
    .search-input-wrapper {
        min-width: unset;
    }
    
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .tipo-buttons {
        grid-template-columns: 1fr;
    }
    
    .bulk-actions {
        flex-direction: column;
        align-items: stretch;
    }
    
    .table-wrapper {
        font-size: 0.85rem;
    }
    
    .data-table th,
    .data-table td {
        padding: 8px 10px;
    }
}

@media (max-width: 576px) {
    .tab-btn {
        padding: 10px 15px;
        font-size: 0.9rem;
    }
    
    .tab-btn i {
        display: none;
    }
}
</style>

<!-- JavaScript -->
<script>
// ==================== CONFIGURACI√ìN Y ESTADO ====================
const AppState = {
    // Configuraci√≥n
    config: {
        itemsPerPage: 10,
        apiTimeout: 15000
    },
    
    // Estado de asignaci√≥n
    asignar: {
        tiendasOrigen: [],
        tiendaOrigenSeleccionada: null,
        tipoSeleccionado: null, // 'internas' o 'externas'
        tiendasDestino: [],
        tiendasDestinoSeleccionadas: new Set(),
        isLoading: false
    },
    
    // Estado de visualizaci√≥n
    ver: {
        asignaciones: [],
        asignacionesFiltradas: [],
        filtro: '',
        currentPage: 1,
        isLoading: false
    },
    
    // Estado de Sicatel
    sicatel: {
        tiendas: [],
        tiendasFiltradas: [],
        tiendasSeleccionadas: new Set(),
        filtro: '',
        currentPage: 1,
        isLoading: false,
        stats: {
            total: 0,
            enabled: 0,
            disabled: 0,
            percent: 0
        }
    },
    
    // Pesta√±as
    activeTab: 'asignar'
};

// Referencias del DOM
const DOM = {
    // Pesta√±as
    tabBtns: document.querySelectorAll('.tab-btn'),
    tabPanels: document.querySelectorAll('.tab-panel'),
    
    // Asignar
    tiendaOrigenSelector: document.getElementById('tienda-origen-selector'),
    capacidadesInfo: document.getElementById('capacidades-info'),
    capacidadesContent: document.getElementById('capacidades-content'),
    tipoAsignacionSection: document.getElementById('tipo-asignacion-section'),
    btnTipoInternas: document.getElementById('btn-tipo-internas'),
    btnTipoExternas: document.getElementById('btn-tipo-externas'),
    busquedaSection: document.getElementById('busqueda-section'),
    searchDestino: document.getElementById('search-destino'),
    btnBuscarDestino: document.getElementById('btn-buscar-destino'),
    btnLimpiarBusqueda: document.getElementById('btn-limpiar-busqueda'),
    destinoContainer: document.getElementById('destino-container'),
    destinoLoading: document.getElementById('destino-loading'),
    destinoError: document.getElementById('destino-error'),
    destinoErrorMessage: document.getElementById('destino-error-message'),
    destinoEmpty: document.getElementById('destino-empty'),
    destinoEmptyMessage: document.getElementById('destino-empty-message'),
    destinoLista: document.getElementById('destino-lista'),
    selectAllDestino: document.getElementById('select-all-destino'),
    contadorSeleccionadas: document.getElementById('contador-seleccionadas'),
    tipoActual: document.getElementById('tipo-actual'),
    tiendasTree: document.getElementById('tiendas-tree'),
    btnAsignar: document.getElementById('btn-asignar'),
    
    // Ver asignaciones
    asignacionesStats: document.getElementById('asignaciones-stats'),
    statTotal: document.getElementById('stat-total'),
    statActivas: document.getElementById('stat-activas'),
    statSicatel: document.getElementById('stat-sicatel'),
    statInternaInterna: document.getElementById('stat-interna-interna'),
    searchAsignaciones: document.getElementById('search-asignaciones'),
    btnBuscarAsignaciones: document.getElementById('btn-buscar-asignaciones'),
    btnLimpiarAsignaciones: document.getElementById('btn-limpiar-asignaciones'),
    asignacionesLoading: document.getElementById('asignaciones-loading'),
    asignacionesError: document.getElementById('asignaciones-error'),
    asignacionesErrorMessage: document.getElementById('asignaciones-error-message'),
    asignacionesEmpty: document.getElementById('asignaciones-empty'),
    asignacionesTableContainer: document.getElementById('asignaciones-table-container'),
    asignacionesTbody: document.getElementById('asignaciones-tbody'),
    asignacionesPagination: document.getElementById('asignaciones-pagination'),
    asignacionesPrev: document.getElementById('asignaciones-prev'),
    asignacionesNext: document.getElementById('asignaciones-next'),
    asignacionesPages: document.getElementById('asignaciones-pages'),
    
    // Sicatel
    sicatelStats: document.getElementById('sicatel-stats'),
    sicatelStatTotal: document.getElementById('sicatel-stat-total'),
    sicatelStatEnabled: document.getElementById('sicatel-stat-enabled'),
    sicatelStatDisabled: document.getElementById('sicatel-stat-disabled'),
    sicatelStatPercent: document.getElementById('sicatel-stat-percent'),
    searchSicatel: document.getElementById('search-sicatel'),
    btnBuscarSicatel: document.getElementById('btn-buscar-sicatel'),
    btnLimpiarSicatel: document.getElementById('btn-limpiar-sicatel'),
    selectAllSicatel: document.getElementById('select-all-sicatel'),
    contadorSicatel: document.getElementById('contador-sicatel'),
    btnEnableBulk: document.getElementById('btn-enable-bulk'),
    btnDisableBulk: document.getElementById('btn-disable-bulk'),
    sicatelLoading: document.getElementById('sicatel-loading'),
    sicatelError: document.getElementById('sicatel-error'),
    sicatelErrorMessage: document.getElementById('sicatel-error-message'),
    sicatelEmpty: document.getElementById('sicatel-empty'),
    sicatelTableContainer: document.getElementById('sicatel-table-container'),
    sicatelTbody: document.getElementById('sicatel-tbody'),
    selectAllTableSicatel: document.getElementById('select-all-table-sicatel'),
    sicatelPagination: document.getElementById('sicatel-pagination'),
    sicatelPrev: document.getElementById('sicatel-prev'),
    sicatelNext: document.getElementById('sicatel-next'),
    sicatelPages: document.getElementById('sicatel-pages')
};

// ==================== UTILIDADES ====================
const Utils = {
    // Obtener datos de usuario
    getUserData() {
        try {
            const userData = sessionStorage.getItem('userData');
            const userUID = sessionStorage.getItem('userUID');
            
            return {
                role: userData ? JSON.parse(userData).role : 'guest',
                uid: userUID || ''
            };
        } catch (error) {
            console.error('Error al obtener datos de usuario:', error);
            return { role: 'guest', uid: '' };
        }
    },
    
    // Realizar petici√≥n API
    async apiRequest(url, options = {}) {
        try {
            const response = await fetch(url, {
                ...options,
                headers: {
                    'Content-Type': 'application/json',
                    ...options.headers
                }
            });
            
            if (!response.ok) {
                throw new Error(`Error HTTP: ${response.status} ${response.statusText}`);
            }
            
            const text = await response.text();
            return JSON.parse(text);
        } catch (error) {
            console.error('Error en petici√≥n API:', error);
            throw error;
        }
    },
    
    // Formatear fecha
    formatDate(dateString) {
        if (!dateString) return 'N/A';
        
        try {
            const date = new Date(dateString);
            return date.toLocaleString('es-MX', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        } catch (error) {
            return dateString;
        }
    },
    
    // Mostrar notificaci√≥n
    showNotification(message, type = 'info') {
        // Por ahora usamos alert, se puede mejorar con una librer√≠a de notificaciones
        if (type === 'error') {
            alert(`Error: ${message}`);
        } else if (type === 'success') {
            alert(`√âxito: ${message}`);
        } else {
            alert(message);
        }
    },
    
    // Debounce para b√∫squedas
    debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }
};

// ==================== M√ìDULO DE PESTA√ëAS ====================
const TabsModule = {
    init() {
        DOM.tabBtns.forEach(btn => {
            btn.addEventListener('click', (e) => {
                const tabId = e.currentTarget.dataset.tab;
                this.switchTab(tabId);
            });
        });
    },
    
    switchTab(tabId) {
        // Actualizar botones
        DOM.tabBtns.forEach(btn => {
            btn.classList.toggle('active', btn.dataset.tab === tabId);
        });
        
        // Actualizar paneles
        DOM.tabPanels.forEach(panel => {
            panel.classList.toggle('active', panel.id === `panel-${tabId}`);
        });
        
        // Actualizar estado
        AppState.activeTab = tabId;
        
        // Cargar datos seg√∫n la pesta√±a
        switch (tabId) {
            case 'asignar':
                AsignarModule.init();
                break;
            case 'ver':
                VerModule.init();
                break;
            case 'sicatel':
                SicatelModule.init();
                break;
        }
    }
};

// ==================== M√ìDULO ASIGNAR ====================
const AsignarModule = {
    init() {
        if (AppState.asignar.tiendasOrigen.length === 0) {
            this.loadTiendasOrigen();
        }
        this.setupEventListeners();
    },
    
    setupEventListeners() {
        // Selector de tienda origen
        DOM.tiendaOrigenSelector.addEventListener('change', () => {
            this.handleTiendaOrigenChange();
        });
        
        // Botones de tipo
        DOM.btnTipoInternas.addEventListener('click', () => {
            this.selectTipo('internas');
        });
        
        DOM.btnTipoExternas.addEventListener('click', () => {
            this.selectTipo('externas');
        });
        
        // B√∫squeda
        DOM.btnBuscarDestino.addEventListener('click', () => {
            this.searchTiendasDestino();
        });
        
        DOM.btnLimpiarBusqueda.addEventListener('click', () => {
            DOM.searchDestino.value = '';
            this.loadTiendasDestino();
        });
        
        DOM.searchDestino.addEventListener('keyup', (e) => {
            if (e.key === 'Enter') {
                this.searchTiendasDestino();
            }
        });
        
        // Selecci√≥n
        DOM.selectAllDestino.addEventListener('change', () => {
            this.handleSelectAll();
        });
        
        // Asignar
        DOM.btnAsignar.addEventListener('click', () => {
            this.asignarTiendas();
        });
    },
    
    async loadTiendasOrigen() {
        try {
            AppState.asignar.isLoading = true;
            const { role, uid } = Utils.getUserData();
            
            const data = await Utils.apiRequest(
                `../api/get_tiendas_internas.php?role=${encodeURIComponent(role)}&uid=${encodeURIComponent(uid)}`
            );
            
            if (data.error) {
                throw new Error(data.error);
            }
            
            AppState.asignar.tiendasOrigen = data.tiendas || [];
            this.renderTiendasOrigen();
            
        } catch (error) {
            console.error('Error al cargar tiendas origen:', error);
            Utils.showNotification(error.message, 'error');
        } finally {
            AppState.asignar.isLoading = false;
        }
    },
    
    renderTiendasOrigen() {
        DOM.tiendaOrigenSelector.innerHTML = '<option value="">Selecciona una tienda</option>';
        
        AppState.asignar.tiendasOrigen.forEach(tienda => {
            const option = document.createElement('option');
            option.value = tienda.id;
            option.textContent = `${tienda.nombre_tienda}${tienda.sicatel ? ' üëë' : ''}`;
            option.dataset.sicatel = tienda.sicatel;
            DOM.tiendaOrigenSelector.appendChild(option);
        });
    },
    
    handleTiendaOrigenChange() {
        const tiendaId = DOM.tiendaOrigenSelector.value;
        
        if (!tiendaId) {
            this.resetSelection();
            return;
        }
        
        const tienda = AppState.asignar.tiendasOrigen.find(t => t.id == tiendaId);
        if (!tienda) return;
        
        AppState.asignar.tiendaOrigenSeleccionada = tienda;
        this.showCapacidades(tienda);
        this.showTipoSelection(tienda);
    },
    
    showCapacidades(tienda) {
        let content = `<strong>${tienda.nombre_tienda}</strong><br>`;
        
        if (tienda.sicatel) {
            content += 'üëë <strong>Con Sicatel</strong> - Puede atender tiendas internas y externas';
        } else {
            content += 'üè™ <strong>Sin Sicatel</strong> - Puede atender solo tiendas externas';
        }
        
        DOM.capacidadesContent.innerHTML = content;
        DOM.capacidadesInfo.style.display = 'block';
    },
    
    showTipoSelection(tienda) {
        // Habilitar/deshabilitar botones seg√∫n capacidades
        DOM.btnTipoInternas.disabled = !tienda.sicatel;
        DOM.btnTipoExternas.disabled = false;
        
        // Mostrar secci√≥n
        DOM.tipoAsignacionSection.style.display = 'block';
        
        // Limpiar selecci√≥n anterior
        this.resetTipoSelection();
    },
    
    selectTipo(tipo) {
        AppState.asignar.tipoSeleccionado = tipo;
        
        // Actualizar UI de botones
        DOM.btnTipoInternas.classList.toggle('active', tipo === 'internas');
        DOM.btnTipoExternas.classList.toggle('active', tipo === 'externas');
        
        // Actualizar placeholder y badge
        if (tipo === 'internas') {
            DOM.searchDestino.placeholder = 'Buscar tiendas internas...';
            DOM.tipoActual.textContent = 'Asignando: Tiendas Internas';
        } else {
            DOM.searchDestino.placeholder = 'Buscar tiendas externas...';
            DOM.tipoActual.textContent = 'Asignando: Tiendas Externas';
        }
        
        // Mostrar b√∫squeda y cargar tiendas
        DOM.busquedaSection.style.display = 'block';
        this.loadTiendasDestino();
    },
    
    async loadTiendasDestino(searchTerm = '') {
        try {
            if (!AppState.asignar.tipoSeleccionado) return;
            
            this.showDestinoLoading();
            
            const { role, uid } = Utils.getUserData();
            let url, data;
            
            if (AppState.asignar.tipoSeleccionado === 'externas') {
                // Cargar tiendas externas
                url = `../api/get_tiendas_externas.php?role=${encodeURIComponent(role)}&uid=${encodeURIComponent(uid)}`;
                if (searchTerm) url += `&search=${encodeURIComponent(searchTerm)}`;
                
                data = await Utils.apiRequest(url);
                if (data.error) throw new Error(data.error);
                
                AppState.asignar.tiendasDestino = data.tiendas || [];
            } else {
                // Cargar tiendas internas (excluyendo la origen)
                url = `../api/get_tiendas_internas.php?role=${encodeURIComponent(role)}&uid=${encodeURIComponent(uid)}`;
                
                data = await Utils.apiRequest(url);
                if (data.error) throw new Error(data.error);
                
                // Filtrar tienda origen y aplicar b√∫squeda
                let tiendas = (data.tiendas || []).filter(t => 
                    t.id != AppState.asignar.tiendaOrigenSeleccionada.id
                );
                
                if (searchTerm) {
                    const filtro = searchTerm.toLowerCase();
                    tiendas = tiendas.filter(t => 
                        t.nombre_tienda.toLowerCase().includes(filtro) ||
                        (t.encargado && t.encargado.toLowerCase().includes(filtro)) ||
                        (t.direccion && t.direccion.toLowerCase().includes(filtro))
                    );
                }
                
                AppState.asignar.tiendasDestino = tiendas;
            }
            
            this.renderTiendasDestino();
            
        } catch (error) {
            console.error('Error al cargar tiendas destino:', error);
            this.showDestinoError(error.message);
        }
    },
    
    searchTiendasDestino() {
        const searchTerm = DOM.searchDestino.value.trim();
        this.loadTiendasDestino(searchTerm);
    },
    
    renderTiendasDestino() {
        if (AppState.asignar.tiendasDestino.length === 0) {
            this.showDestinoEmpty();
            return;
        }
        
        DOM.tiendasTree.innerHTML = '';
        AppState.asignar.tiendasDestinoSeleccionadas.clear();
        
        if (AppState.asignar.tipoSeleccionado === 'externas') {
            this.renderTiendasExternas();
        } else {
            this.renderTiendasInternas();
        }
        
        this.showDestinoLista();
        this.updateContadores();
    },
    
    renderTiendasExternas() {
        const principales = AppState.asignar.tiendasDestino.filter(t => !t.tienda_principal_id);
        
        principales.forEach(principal => {
            const sucursales = AppState.asignar.tiendasDestino.filter(t => 
                t.tienda_principal_id === principal.id
            );
            
            const item = document.createElement('div');
            item.className = 'tree-item';
            
            const hasChildren = sucursales.length > 0;
            
            item.innerHTML = `
                <div class="tree-parent">
                    <div class="tree-parent-content">
                        ${hasChildren ? 
                            '<div class="tree-toggle"><i class="fas fa-plus"></i></div>' : 
                            '<div style="width: 24px; margin-right: 12px;"></div>'
                        }
                        <input type="checkbox" class="tree-checkbox" data-id="${principal.id}">
                        <span class="tree-name">${principal.nombre_tienda}</span>
                    </div>
                    <div class="tree-badge">${sucursales.length} sucursales</div>
                </div>
            `;
            
            // Agregar sucursales si existen
            if (hasChildren) {
                const childrenContainer = document.createElement('div');
                childrenContainer.className = 'tree-children';
                
                sucursales.forEach(sucursal => {
                    const childItem = document.createElement('div');
                    childItem.className = 'tree-child';
                    childItem.innerHTML = `
                        <input type="checkbox" class="tree-checkbox" data-id="${sucursal.id}">
                        <div class="tree-child-info">
                            <span class="tree-child-name">${sucursal.nombre_tienda}</span>
                            <span class="tree-child-detail">${sucursal.direccion || 'Sin direcci√≥n'}</span>
                        </div>
                    `;
                    childrenContainer.appendChild(childItem);
                });
                
                item.appendChild(childrenContainer);
                
                // Evento toggle
                const toggle = item.querySelector('.tree-toggle');
                if (toggle) {
                    toggle.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.toggleTreeNode(item);
                    });
                }
            }
            
            this.setupTreeItemEvents(item);
            DOM.tiendasTree.appendChild(item);
        });
    },
    
    renderTiendasInternas() {
        AppState.asignar.tiendasDestino.forEach(tienda => {
            const item = document.createElement('div');
            item.className = 'tree-item';
            
            item.innerHTML = `
                <div class="tree-parent">
                    <div class="tree-parent-content">
                        <div style="width: 24px; margin-right: 12px;"></div>
                        <input type="checkbox" class="tree-checkbox" data-id="${tienda.id}">
                        <span class="tree-name">
                            ${tienda.nombre_tienda}
                            ${tienda.sicatel ? '<i class="fas fa-crown sicatel-crown"></i>' : ''}
                        </span>
                    </div>
                    <div class="tree-badge">${tienda.tipoTienda || 'Sin tipo'}</div>
                </div>
            `;
            
            this.setupTreeItemEvents(item);
            DOM.tiendasTree.appendChild(item);
        });
    },
    
    setupTreeItemEvents(item) {
        const checkboxes = item.querySelectorAll('.tree-checkbox');
        
        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', (e) => {
                const tiendaId = e.target.dataset.id;
                
                if (e.target.checked) {
                    AppState.asignar.tiendasDestinoSeleccionadas.add(tiendaId);
                } else {
                    AppState.asignar.tiendasDestinoSeleccionadas.delete(tiendaId);
                }
                
                // Si es checkbox padre, actualizar hijos
                if (e.target.closest('.tree-parent')) {
                    const children = item.querySelectorAll('.tree-child .tree-checkbox');
                    children.forEach(childCheckbox => {
                        childCheckbox.checked = e.target.checked;
                        const childId = childCheckbox.dataset.id;
                        
                        if (e.target.checked) {
                            AppState.asignar.tiendasDestinoSeleccionadas.add(childId);
                        } else {
                            AppState.asignar.tiendasDestinoSeleccionadas.delete(childId);
                        }
                    });
                }
                
                this.updateContadores();
            });
        });
    },
    
    toggleTreeNode(item) {
        const toggle = item.querySelector('.tree-toggle i');
        const children = item.querySelector('.tree-children');
        
        if (children.classList.contains('expanded')) {
            children.classList.remove('expanded');
            toggle.className = 'fas fa-plus';
        } else {
            children.classList.add('expanded');
            toggle.className = 'fas fa-minus';
        }
    },
    
    handleSelectAll() {
        const checkboxes = DOM.tiendasTree.querySelectorAll('.tree-checkbox');
        
        checkboxes.forEach(checkbox => {
            checkbox.checked = DOM.selectAllDestino.checked;
            const tiendaId = checkbox.dataset.id;
            
            if (DOM.selectAllDestino.checked) {
                AppState.asignar.tiendasDestinoSeleccionadas.add(tiendaId);
            } else {
                AppState.asignar.tiendasDestinoSeleccionadas.delete(tiendaId);
            }
        });
        
        this.updateContadores();
    },
    
    updateContadores() {
        const count = AppState.asignar.tiendasDestinoSeleccionadas.size;
        DOM.contadorSeleccionadas.textContent = `${count} seleccionadas`;
        DOM.btnAsignar.disabled = count === 0 || !AppState.asignar.tiendaOrigenSeleccionada;
    },
    
    async asignarTiendas() {
        try {
            if (!AppState.asignar.tiendaOrigenSeleccionada || AppState.asignar.tiendasDestinoSeleccionadas.size === 0) {
                throw new Error('Faltan datos para la asignaci√≥n');
            }
            
            DOM.btnAsignar.disabled = true;
            DOM.btnAsignar.innerHTML = '<div class="spinner" style="width: 20px; height: 20px; margin-right: 8px;"></div> Procesando...';
            
            const { uid } = Utils.getUserData();
            
            const data = {
                tienda_origen_id: AppState.asignar.tiendaOrigenSeleccionada.id,
                tiendas_destino: Array.from(AppState.asignar.tiendasDestinoSeleccionadas),
                usuario_asignacion: uid
            };
            
            const result = await Utils.apiRequest('../api/asignar_atencion.php', {
                method: 'POST',
                body: JSON.stringify(data)
            });
            
            if (result.error) {
                throw new Error(result.error);
            }
            
            // Mostrar resultado
            const mensaje = `Asignaci√≥n exitosa:\n${result.asignadas} tiendas asignadas correctamente.\n\n` +
                           `Detalles:\n${result.detalles.join('\n')}`;
            Utils.showNotification(mensaje, 'success');
            
            // Limpiar formulario
            this.resetForm();
            
            // Cambiar a pesta√±a de visualizaci√≥n
            TabsModule.switchTab('ver');
            
        } catch (error) {
            console.error('Error al asignar tiendas:', error);
            Utils.showNotification(error.message, 'error');
        } finally {
            DOM.btnAsignar.disabled = false;
            DOM.btnAsignar.innerHTML = '<i class="fas fa-link"></i> Asignar tiendas seleccionadas';
        }
    },
    
    // Estados UI
    showDestinoLoading() {
        DOM.destinoContainer.style.display = 'block';
        DOM.destinoLoading.style.display = 'flex';
        DOM.destinoError.style.display = 'none';
        DOM.destinoEmpty.style.display = 'none';
        DOM.destinoLista.style.display = 'none';
    },
    
    showDestinoError(message) {
        DOM.destinoLoading.style.display = 'none';
        DOM.destinoError.style.display = 'flex';
        DOM.destinoErrorMessage.textContent = message;
    },
    
    showDestinoEmpty() {
        DOM.destinoLoading.style.display = 'none';
        DOM.destinoEmpty.style.display = 'block';
        DOM.destinoEmptyMessage.textContent = DOM.searchDestino.value.trim() ? 
            'No se encontraron tiendas que coincidan con la b√∫squeda' : 
            'No hay tiendas disponibles para este tipo de asignaci√≥n';
    },
    
    showDestinoLista() {
        DOM.destinoLoading.style.display = 'none';
        DOM.destinoLista.style.display = 'block';
    },
    
    // Reset
    resetSelection() {
        AppState.asignar.tiendaOrigenSeleccionada = null;
        AppState.asignar.tipoSeleccionado = null;
        AppState.asignar.tiendasDestinoSeleccionadas.clear();
        
        DOM.capacidadesInfo.style.display = 'none';
        DOM.tipoAsignacionSection.style.display = 'none';
        DOM.busquedaSection.style.display = 'none';
        DOM.destinoContainer.style.display = 'none';
    },
    
    resetTipoSelection() {
        AppState.asignar.tipoSeleccionado = null;
        AppState.asignar.tiendasDestinoSeleccionadas.clear();
        
        DOM.btnTipoInternas.classList.remove('active');
        DOM.btnTipoExternas.classList.remove('active');
        DOM.busquedaSection.style.display = 'none';
        DOM.destinoContainer.style.display = 'none';
    },
    
    resetForm() {
        DOM.tiendaOrigenSelector.value = '';
        DOM.searchDestino.value = '';
        this.resetSelection();
    }
};

// ==================== M√ìDULO VER ====================
const VerModule = {
    init() {
        this.setupEventListeners();
        this.loadAsignaciones();
    },
    
    setupEventListeners() {
        // B√∫squeda
        DOM.btnBuscarAsignaciones.addEventListener('click', () => {
            this.searchAsignaciones();
        });
        
        DOM.btnLimpiarAsignaciones.addEventListener('click', () => {
            DOM.searchAsignaciones.value = '';
            AppState.ver.filtro = '';
            AppState.ver.currentPage = 1;
            this.filterAndRenderAsignaciones();
        });
        
        DOM.searchAsignaciones.addEventListener('keyup', (e) => {
            if (e.key === 'Enter') {
                this.searchAsignaciones();
            }
        });
        
        // Paginaci√≥n
        DOM.asignacionesPrev.addEventListener('click', () => {
            if (AppState.ver.currentPage > 1) {
                AppState.ver.currentPage--;
                this.renderAsignaciones();
                this.updatePagination();
            }
        });
        
        DOM.asignacionesNext.addEventListener('click', () => {
            const totalPages = Math.ceil(AppState.ver.asignacionesFiltradas.length / AppState.config.itemsPerPage);
            if (AppState.ver.currentPage < totalPages) {
                AppState.ver.currentPage++;
                this.renderAsignaciones();
                this.updatePagination();
            }
        });
    },
    
    async loadAsignaciones() {
        try {
            AppState.ver.isLoading = true;
            this.showLoading();
            
            const { role, uid } = Utils.getUserData();
            
            const data = await Utils.apiRequest(
                `../api/get_asignaciones.php?role=${encodeURIComponent(role)}&uid=${encodeURIComponent(uid)}`
            );
            
            if (data.error) {
                throw new Error(data.error);
            }
            
            AppState.ver.asignaciones = data.asignaciones || [];
            
            // Actualizar estad√≠sticas
            if (data.estadisticas) {
                this.updateStats(data.estadisticas);
            }
            
            this.filterAndRenderAsignaciones();
            
        } catch (error) {
            console.error('Error al cargar asignaciones:', error);
            this.showError(error.message);
        } finally {
            AppState.ver.isLoading = false;
        }
    },
    
    updateStats(stats) {
        DOM.statTotal.textContent = stats.total || 0;
        DOM.statActivas.textContent = stats.activas || 0;
        DOM.statSicatel.textContent = stats.sicatel_stats?.tiendas_da_con_sicatel || 0;
        DOM.statInternaInterna.textContent = stats.por_tipo?.interna_a_interna || 0;
        
        DOM.asignacionesStats.style.display = 'grid';
    },
    
    searchAsignaciones() {
        AppState.ver.filtro = DOM.searchAsignaciones.value.trim();
        AppState.ver.currentPage = 1;
        this.filterAndRenderAsignaciones();
    },
    
    filterAndRenderAsignaciones() {
        let filtered = AppState.ver.asignaciones;
        
        if (AppState.ver.filtro) {
            const filtro = AppState.ver.filtro.toLowerCase();
            filtered = AppState.ver.asignaciones.filter(asignacion => {
                return (
                    asignacion.tienda_da_atencion_nombre.toLowerCase().includes(filtro) ||
                    asignacion.tienda_recibe_atencion_nombre.toLowerCase().includes(filtro) ||
                    asignacion.tipo_asignacion_descripcion.toLowerCase().includes(filtro)
                );
            });
        }
        
        AppState.ver.asignacionesFiltradas = filtered;
        
        if (filtered.length === 0) {
            this.showEmpty();
            return;
        }
        
        this.renderAsignaciones();
        this.updatePagination();
        this.showTable();
    },
    
    renderAsignaciones() {
        const startIndex = (AppState.ver.currentPage - 1) * AppState.config.itemsPerPage;
        const endIndex = Math.min(startIndex + AppState.config.itemsPerPage, AppState.ver.asignacionesFiltradas.length);
        const pageItems = AppState.ver.asignacionesFiltradas.slice(startIndex, endIndex);
        
        DOM.asignacionesTbody.innerHTML = '';
        
        pageItems.forEach(asignacion => {
            const row = document.createElement('tr');
            
            // Iconos para sicatel
            const origenIcon = asignacion.tienda_da_atencion_sicatel ? 
                '<i class="fas fa-crown sicatel-crown" title="Con sicatel"></i> ' : '';
            const destinoIcon = asignacion.tienda_recibe_atencion_sicatel ? 
                '<i class="fas fa-crown sicatel-crown" title="Con sicatel"></i> ' : '';
            
            // Clase CSS para el tipo
            let tipoClase = '';
            switch (asignacion.tipo_asignacion) {
                case 'interna_a_interna': tipoClase = 'tipo-interna-interna'; break;
                case 'interna_a_externa': tipoClase = 'tipo-interna-externa'; break;
                case 'externa_a_interna': tipoClase = 'tipo-externa-interna'; break;
            }
            
            row.innerHTML = `
                <td>
                    ${origenIcon}${asignacion.tienda_da_atencion_nombre}
                    <br><small style="color: var(--text-secondary);">${asignacion.tienda_da_atencion_canal}</small>
                </td>
                <td>
                    ${destinoIcon}${asignacion.tienda_recibe_atencion_nombre}
                    <br><small style="color: var(--text-secondary);">${asignacion.tienda_recibe_atencion_canal}</small>
                </td>
                <td>
                    <span class="tipo-asignacion-badge ${tipoClase}">
                        <i class="${asignacion.tipo_asignacion_icono}"></i>
                        ${asignacion.tipo_asignacion_descripcion}
                    </span>
                </td>
                <td>${Utils.formatDate(asignacion.fecha_asignacion)}</td>
                <td>
                    <span class="status-badge ${asignacion.estado ? 'status-active' : 'status-inactive'}">
                        ${asignacion.estado ? 'Activo' : 'Inactivo'}
                    </span>
                </td>
                <td>
                    ${asignacion.estado ? 
                        `<button class="btn btn-danger btn-sm" data-id="${asignacion.id}">
                            <i class="fas fa-times"></i> Desactivar
                        </button>` : 
                        `<button class="btn btn-success btn-sm" data-id="${asignacion.id}">
                            <i class="fas fa-check"></i> Activar
                        </button>`
                    }
                </td>
            `;
            
            // Evento para bot√≥n de acci√≥n
            const btnAccion = row.querySelector('.btn');
            btnAccion.addEventListener('click', () => {
                this.cambiarEstadoAsignacion(asignacion.id, !asignacion.estado);
            });
            
            DOM.asignacionesTbody.appendChild(row);
        });
    },
    
    updatePagination() {
        const totalPages = Math.ceil(AppState.ver.asignacionesFiltradas.length / AppState.config.itemsPerPage);
        
        DOM.asignacionesPrev.disabled = AppState.ver.currentPage <= 1;
        DOM.asignacionesNext.disabled = AppState.ver.currentPage >= totalPages;
        
        DOM.asignacionesPages.innerHTML = '';
        
        if (totalPages <= 1) {
            DOM.asignacionesPagination.style.display = 'none';
            return;
        }
        
        DOM.asignacionesPagination.style.display = 'flex';
        
        // Generar n√∫meros de p√°gina
        let startPage = Math.max(1, AppState.ver.currentPage - 2);
        let endPage = Math.min(totalPages, startPage + 4);
        
        if (endPage - startPage < 4) {
            startPage = Math.max(1, endPage - 4);
        }
        
        // Primera p√°gina
        if (startPage > 1) {
            this.addPageNumber(1);
            if (startPage > 2) {
                this.addEllipsis('asignaciones');
            }
        }
        
        // P√°ginas intermedias
        for (let i = startPage; i <= endPage; i++) {
            this.addPageNumber(i);
        }
        
        // √öltima p√°gina
        if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
                this.addEllipsis('asignaciones');
            }
            this.addPageNumber(totalPages);
        }
    },
    
    addPageNumber(pageNum) {
        const pageBtn = document.createElement('div');
        pageBtn.className = `page-number ${pageNum === AppState.ver.currentPage ? 'active' : ''}`;
        pageBtn.textContent = pageNum;
        pageBtn.addEventListener('click', () => {
            if (pageNum !== AppState.ver.currentPage) {
                AppState.ver.currentPage = pageNum;
                this.renderAsignaciones();
                this.updatePagination();
            }
        });
        DOM.asignacionesPages.appendChild(pageBtn);
    },
    
    addEllipsis(type) {
        const ellipsis = document.createElement('div');
        ellipsis.className = 'page-ellipsis';
        ellipsis.textContent = '...';
        DOM.asignacionesPages.appendChild(ellipsis);
    },
    
    async cambiarEstadoAsignacion(id, nuevoEstado) {
        try {
            const { role, uid } = Utils.getUserData();
            
            const data = {
                id: id,
                estado: nuevoEstado ? 1 : 0,
                user_uid: uid,
                role: role
            };
            
            const result = await Utils.apiRequest('../api/actualizar_asignacion.php', {
                method: 'POST',
                body: JSON.stringify(data)
            });
            
            if (result.error) {
                throw new Error(result.error);
            }
            
            // Recargar asignaciones
            this.loadAsignaciones();
            
        } catch (error) {
            console.error('Error al cambiar estado:', error);
            Utils.showNotification(error.message, 'error');
        }
    },
    
    // Estados UI
    showLoading() {
        DOM.asignacionesLoading.style.display = 'flex';
        DOM.asignacionesError.style.display = 'none';
        DOM.asignacionesEmpty.style.display = 'none';
        DOM.asignacionesTableContainer.style.display = 'none';
        DOM.asignacionesStats.style.display = 'none';
    },
    
    showError(message) {
        DOM.asignacionesLoading.style.display = 'none';
        DOM.asignacionesError.style.display = 'flex';
        DOM.asignacionesErrorMessage.textContent = message;
    },
    
    showEmpty() {
        DOM.asignacionesLoading.style.display = 'none';
        DOM.asignacionesEmpty.style.display = 'block';
        DOM.asignacionesTableContainer.style.display = 'none';
    },
    
    showTable() {
        DOM.asignacionesLoading.style.display = 'none';
        DOM.asignacionesTableContainer.style.display = 'block';
        DOM.asignacionesEmpty.style.display = 'none';
    }
};

// ==================== M√ìDULO SICATEL ====================
const SicatelModule = {
    init() {
        this.setupEventListeners();
        this.loadTiendas();
    },
    
    setupEventListeners() {
        // B√∫squeda
        DOM.btnBuscarSicatel.addEventListener('click', () => {
            this.searchTiendas();
        });
        
        DOM.btnLimpiarSicatel.addEventListener('click', () => {
            DOM.searchSicatel.value = '';
            AppState.sicatel.filtro = '';
            AppState.sicatel.currentPage = 1;
            this.filterAndRenderTiendas();
        });
        
        DOM.searchSicatel.addEventListener('keyup', (e) => {
            if (e.key === 'Enter') {
                this.searchTiendas();
            }
        });
        
        // Selecci√≥n masiva
        DOM.selectAllSicatel.addEventListener('change', () => {
            this.handleSelectAll();
        });
        
        DOM.selectAllTableSicatel.addEventListener('change', () => {
            this.handleSelectAllTable();
        });
        
        // Acciones masivas
        DOM.btnEnableBulk.addEventListener('click', () => {
            this.changeSicatelBulk(true);
        });
        
        DOM.btnDisableBulk.addEventListener('click', () => {
            this.changeSicatelBulk(false);
        });
        
        // Paginaci√≥n
        DOM.sicatelPrev.addEventListener('click', () => {
            if (AppState.sicatel.currentPage > 1) {
                AppState.sicatel.currentPage--;
                this.renderTiendas();
                this.updatePagination();
            }
        });
        
        DOM.sicatelNext.addEventListener('click', () => {
            const totalPages = Math.ceil(AppState.sicatel.tiendasFiltradas.length / AppState.config.itemsPerPage);
            if (AppState.sicatel.currentPage < totalPages) {
                AppState.sicatel.currentPage++;
                this.renderTiendas();
                this.updatePagination();
            }
        });
    },
    
    async loadTiendas() {
        try {
            AppState.sicatel.isLoading = true;
            this.showLoading();
            
            const { role, uid } = Utils.getUserData();
            
            const data = await Utils.apiRequest(
                `../api/get_tiendas_internas.php?role=${encodeURIComponent(role)}&uid=${encodeURIComponent(uid)}`
            );
            
            if (data.error) {
                throw new Error(data.error);
            }
            
            AppState.sicatel.tiendas = data.tiendas || [];
            
            this.updateStats();
            this.filterAndRenderTiendas();
            
        } catch (error) {
            console.error('Error al cargar tiendas sicatel:', error);
            this.showError(error.message);
        } finally {
            AppState.sicatel.isLoading = false;
        }
    },
    
    updateStats() {
        const total = AppState.sicatel.tiendas.length;
        const enabled = AppState.sicatel.tiendas.filter(t => t.sicatel).length;
        const disabled = total - enabled;
        const percent = total > 0 ? Math.round((enabled / total) * 100) : 0;
        
        AppState.sicatel.stats = { total, enabled, disabled, percent };
        
        DOM.sicatelStatTotal.textContent = total;
        DOM.sicatelStatEnabled.textContent = enabled;
        DOM.sicatelStatDisabled.textContent = disabled;
        DOM.sicatelStatPercent.textContent = `${percent}%`;
        
        DOM.sicatelStats.style.display = 'grid';
    },
    
    searchTiendas() {
        AppState.sicatel.filtro = DOM.searchSicatel.value.trim();
        AppState.sicatel.currentPage = 1;
        this.filterAndRenderTiendas();
    },
    
    filterAndRenderTiendas() {
        let filtered = AppState.sicatel.tiendas;
        
        if (AppState.sicatel.filtro) {
            const filtro = AppState.sicatel.filtro.toLowerCase();
            filtered = AppState.sicatel.tiendas.filter(tienda => {
                return (
                    tienda.nombre_tienda.toLowerCase().includes(filtro) ||
                    (tienda.encargado && tienda.encargado.toLowerCase().includes(filtro)) ||
                    (tienda.direccion && tienda.direccion.toLowerCase().includes(filtro)) ||
                    (tienda.tipoTienda && tienda.tipoTienda.toLowerCase().includes(filtro))
                );
            });
        }
        
        AppState.sicatel.tiendasFiltradas = filtered;
        
        if (filtered.length === 0) {
            this.showEmpty();
            return;
        }
        
        this.renderTiendas();
        this.updatePagination();
        this.showTable();
    },
    
    renderTiendas() {
        const startIndex = (AppState.sicatel.currentPage - 1) * AppState.config.itemsPerPage;
        const endIndex = Math.min(startIndex + AppState.config.itemsPerPage, AppState.sicatel.tiendasFiltradas.length);
        const pageItems = AppState.sicatel.tiendasFiltradas.slice(startIndex, endIndex);
        
        DOM.sicatelTbody.innerHTML = '';
        
        pageItems.forEach(tienda => {
            const row = document.createElement('tr');
            
            const statusBadge = tienda.sicatel ? 
                '<span class="status-badge status-active"><i class="fas fa-crown"></i> Sicatel habilitado</span>' :
                '<span class="status-badge status-inactive"><i class="fas fa-store"></i> Sicatel deshabilitado</span>';
            
            row.innerHTML = `
                <td>
                    <input type="checkbox" class="row-checkbox" data-id="${tienda.id}" 
                           ${AppState.sicatel.tiendasSeleccionadas.has(tienda.id) ? 'checked' : ''}>
                </td>
                <td>
                    <div>
                        <strong>${tienda.nombre_tienda}</strong>
                        ${tienda.sicatel ? '<i class="fas fa-crown sicatel-crown"></i>' : ''}
                        ${tienda.direccion ? `<br><small style="color: var(--text-secondary);">${tienda.direccion}</small>` : ''}
                    </div>
                </td>
                <td>${tienda.encargado || 'Sin asignar'}</td>
                <td>${tienda.tipoTienda || 'Sin especificar'}</td>
                <td>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        ${statusBadge}
                        <label class="sicatel-toggle">
                            <input type="checkbox" ${tienda.sicatel ? 'checked' : ''} data-tienda-id="${tienda.id}">
                            <span class="sicatel-slider"></span>
                        </label>
                    </div>
                </td>
                <td>
                    ${!tienda.sicatel ? 
                        `<button class="btn btn-success btn-sm" data-tienda-id="${tienda.id}" data-action="enable">
                            <i class="fas fa-crown"></i> Habilitar
                        </button>` :
                        `<button class="btn btn-warning btn-sm" data-tienda-id="${tienda.id}" data-action="disable">
                            <i class="fas fa-times"></i> Deshabilitar
                        </button>`
                    }
                </td>
            `;
            
            // Eventos
            const rowCheckbox = row.querySelector('.row-checkbox');
            rowCheckbox.addEventListener('change', (e) => {
                const tiendaId = e.target.dataset.id;
                if (e.target.checked) {
                    AppState.sicatel.tiendasSeleccionadas.add(tiendaId);
                } else {
                    AppState.sicatel.tiendasSeleccionadas.delete(tiendaId);
                }
                this.updateBulkControls();
            });
            
            const toggle = row.querySelector('.sicatel-toggle input');
            toggle.addEventListener('change', (e) => {
                this.changeSicatelIndividual(e.target.dataset.tiendaId, e.target.checked);
            });
            
            const btnQuick = row.querySelector('.btn');
            btnQuick.addEventListener('click', (e) => {
                const tiendaId = e.target.dataset.tiendaId;
                const action = e.target.dataset.action;
                this.changeSicatelIndividual(tiendaId, action === 'enable');
            });
            
            DOM.sicatelTbody.appendChild(row);
        });
        
        this.updateBulkControls();
        this.updateSelectAllCheckboxes();
    },
    
    updatePagination() {
        const totalPages = Math.ceil(AppState.sicatel.tiendasFiltradas.length / AppState.config.itemsPerPage);
        
        DOM.sicatelPrev.disabled = AppState.sicatel.currentPage <= 1;
        DOM.sicatelNext.disabled = AppState.sicatel.currentPage >= totalPages;
        
        DOM.sicatelPages.innerHTML = '';
        
        if (totalPages <= 1) {
            DOM.sicatelPagination.style.display = 'none';
            return;
        }
        
        DOM.sicatelPagination.style.display = 'flex';
        
        // Generar n√∫meros de p√°gina (similar a VerModule)
        let startPage = Math.max(1, AppState.sicatel.currentPage - 2);
        let endPage = Math.min(totalPages, startPage + 4);
        
        if (endPage - startPage < 4) {
            startPage = Math.max(1, endPage - 4);
        }
        
        if (startPage > 1) {
            this.addPageNumber(1);
            if (startPage > 2) {
                this.addEllipsis();
            }
        }
        
        for (let i = startPage; i <= endPage; i++) {
            this.addPageNumber(i);
        }
        
        if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
                this.addEllipsis();
            }
            this.addPageNumber(totalPages);
        }
    },
    
    addPageNumber(pageNum) {
        const pageBtn = document.createElement('div');
        pageBtn.className = `page-number ${pageNum === AppState.sicatel.currentPage ? 'active' : ''}`;
        pageBtn.textContent = pageNum;
        pageBtn.addEventListener('click', () => {
            if (pageNum !== AppState.sicatel.currentPage) {
                AppState.sicatel.currentPage = pageNum;
                this.renderTiendas();
                this.updatePagination();
            }
        });
        DOM.sicatelPages.appendChild(pageBtn);
    },
    
    addEllipsis() {
        const ellipsis = document.createElement('div');
        ellipsis.className = 'page-ellipsis';
        ellipsis.textContent = '...';
        DOM.sicatelPages.appendChild(ellipsis);
    },
    
    handleSelectAll() {
        if (DOM.selectAllSicatel.checked) {
            AppState.sicatel.tiendasFiltradas.forEach(tienda => {
                AppState.sicatel.tiendasSeleccionadas.add(tienda.id);
            });
        } else {
            AppState.sicatel.tiendasSeleccionadas.clear();
        }
        
        this.updateTableCheckboxes();
        this.updateBulkControls();
    },
    
    handleSelectAllTable() {
        const checkboxes = document.querySelectorAll('.row-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.checked = DOM.selectAllTableSicatel.checked;
            const tiendaId = checkbox.dataset.id;
            
            if (DOM.selectAllTableSicatel.checked) {
                AppState.sicatel.tiendasSeleccionadas.add(tiendaId);
            } else {
                AppState.sicatel.tiendasSeleccionadas.delete(tiendaId);
            }
        });
        
        this.updateBulkControls();
        this.updateSelectAllCheckboxes();
    },
    
    updateTableCheckboxes() {
        const checkboxes = document.querySelectorAll('.row-checkbox');
        checkboxes.forEach(checkbox => {
            const tiendaId = checkbox.dataset.id;
            checkbox.checked = AppState.sicatel.tiendasSeleccionadas.has(tiendaId);
        });
    },
    
    updateBulkControls() {
        const count = AppState.sicatel.tiendasSeleccionadas.size;
        DOM.contadorSicatel.textContent = `${count} seleccionadas`;
        DOM.btnEnableBulk.disabled = count === 0;
        DOM.btnDisableBulk.disabled = count === 0;
    },
    
    updateSelectAllCheckboxes() {
        const totalVisible = AppState.sicatel.tiendasFiltradas.length;
        const selected = AppState.sicatel.tiendasFiltradas.filter(t => 
            AppState.sicatel.tiendasSeleccionadas.has(t.id)
        ).length;
        
        const allSelected = selected === totalVisible && totalVisible > 0;
        DOM.selectAllSicatel.checked = allSelected;
        DOM.selectAllTableSicatel.checked = allSelected;
    },
    
    async changeSicatelIndividual(tiendaId, enable) {
        try {
            await this.updateSicatelAPI([tiendaId], enable);
            
            // Actualizar estado local
            const tienda = AppState.sicatel.tiendas.find(t => t.id == tiendaId);
            if (tienda) {
                tienda.sicatel = enable;
            }
            
            // Actualizar UI
            this.updateStats();
            this.renderTiendas();
            this.updatePagination();
            
            // Recargar tiendas origen si est√° en la pesta√±a asignar
            if (AppState.activeTab === 'asignar') {
                AsignarModule.loadTiendasOrigen();
            }
            
        } catch (error) {
            console.error('Error al cambiar sicatel individual:', error);
            Utils.showNotification(error.message, 'error');
            
            // Revertir UI
            setTimeout(() => {
                this.renderTiendas();
            }, 100);
        }
    },
    
    async changeSicatelBulk(enable) {
        try {
            if (AppState.sicatel.tiendasSeleccionadas.size === 0) {
                Utils.showNotification('Selecciona al menos una tienda', 'error');
                return;
            }
            
            const accion = enable ? 'habilitar' : 'deshabilitar';
            const confirmacion = confirm(`¬øEst√°s seguro de ${accion} sicatel en ${AppState.sicatel.tiendasSeleccionadas.size} tienda(s)?`);
            
            if (!confirmacion) return;
            
            // Deshabilitar botones
            DOM.btnEnableBulk.disabled = true;
            DOM.btnDisableBulk.disabled = true;
            
            await this.updateSicatelAPI(Array.from(AppState.sicatel.tiendasSeleccionadas), enable);
            
            // Actualizar estado local
            AppState.sicatel.tiendasSeleccionadas.forEach(tiendaId => {
                const tienda = AppState.sicatel.tiendas.find(t => t.id == tiendaId);
                if (tienda) {
                    tienda.sicatel = enable;
                }
            });
            
            // Limpiar selecci√≥n
            AppState.sicatel.tiendasSeleccionadas.clear();
            
            // Actualizar UI
            this.updateStats();
            this.renderTiendas();
            this.updatePagination();
            
            // Recargar tiendas origen si est√° en la pesta√±a asignar
            if (AppState.activeTab === 'asignar') {
                AsignarModule.loadTiendasOrigen();
            }
            
            Utils.showNotification(`Sicatel ${accion} exitosamente en las tiendas seleccionadas`, 'success');
            
        } catch (error) {
            console.error('Error al cambiar sicatel masivo:', error);
            Utils.showNotification(error.message, 'error');
        } finally {
            this.updateBulkControls();
        }
    },
    
    async updateSicatelAPI(tiendaIds, enable) {
        const { role, uid } = Utils.getUserData();
        
        const data = {
            tienda_ids: tiendaIds,
            sicatel: enable,
            user_uid: uid,
            role: role
        };
        
        const result = await Utils.apiRequest('../api/actualizar_sicatel.php', {
            method: 'POST',
            body: JSON.stringify(data)
        });
        
        if (result.error) {
            throw new Error(result.error);
        }
        
        return result;
    },
    
    // Estados UI
    showLoading() {
        DOM.sicatelLoading.style.display = 'flex';
        DOM.sicatelError.style.display = 'none';
        DOM.sicatelEmpty.style.display = 'none';
        DOM.sicatelTableContainer.style.display = 'none';
        DOM.sicatelStats.style.display = 'none';
    },
    
    showError(message) {
        DOM.sicatelLoading.style.display = 'none';
        DOM.sicatelError.style.display = 'flex';
        DOM.sicatelErrorMessage.textContent = message;
    },
    
    showEmpty() {
        DOM.sicatelLoading.style.display = 'none';
        DOM.sicatelEmpty.style.display = 'block';
        DOM.sicatelTableContainer.style.display = 'none';
    },
    
    showTable() {
        DOM.sicatelLoading.style.display = 'none';
        DOM.sicatelTableContainer.style.display = 'block';
        DOM.sicatelEmpty.style.display = 'none';
    }
};

// ==================== INICIALIZACI√ìN ====================
function initApp() {
    try {
        console.log('Inicializando aplicaci√≥n de Atenci√≥n al Cliente v3.0...');
        
        // Verificar elementos cr√≠ticos
        if (!DOM.tiendaOrigenSelector) {
            throw new Error('Elemento tienda-origen-selector no encontrado');
        }
        
        // Inicializar m√≥dulos
        TabsModule.init();
        
        // Cargar pesta√±a inicial
        TabsModule.switchTab('asignar');
        
        console.log('Aplicaci√≥n inicializada correctamente');
        
    } catch (error) {
        console.error('Error cr√≠tico en inicializaci√≥n:', error);
        Utils.showNotification(`Error de inicializaci√≥n: ${error.message}`, 'error');
    }
}

// ==================== FUNCIONES DE DEBUG ====================
window.AtencionClienteDebug = {
    state: () => AppState,
    modules: {
        asignar: AsignarModule,
        ver: VerModule,
        sicatel: SicatelModule
    },
    dom: DOM,
    utils: Utils
};

// Inicializar cuando el DOM est√© listo
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initApp);
} else {
    initApp();
}
</script>
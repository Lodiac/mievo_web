<div class="card">
    <h2 class="content-title">
        <i class="fas fa-wallet"></i> Gestión de Recargas de Saldo
    </h2>
    
    <!-- Estadísticas -->
    <div class="stats-container">
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-receipt"></i></div>
            <div class="stat-content">
                <div class="stat-value" id="total-recargas">0</div>
                <div class="stat-label">Total Recargas</div>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-clock"></i></div>
            <div class="stat-content">
                <div class="stat-value" id="recargas-pendientes">0</div>
                <div class="stat-label">Pendientes</div>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
            <div class="stat-content">
                <div class="stat-value" id="recargas-aprobadas">0</div>
                <div class="stat-label">Aprobadas</div>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-dollar-sign"></i></div>
            <div class="stat-content">
                <div class="stat-value" id="monto-total">$0.00</div>
                <div class="stat-label">Monto Total</div>
            </div>
        </div>
    </div>
    
    <!-- Filtros -->
    <div class="filters-container">
        <div class="filter-group">
            <label for="filter-estado">Estado:</label>
            <select id="filter-estado" class="filter-select">
                <option value="">Todos</option>
                <option value="pendiente">Pendiente</option>
                <option value="aprobado">Aprobado</option>
                <option value="rechazado">Rechazado</option>
            </select>
        </div>
        
        <div class="filter-group">
            <label for="filter-search">Buscar:</label>
            <input type="text" id="filter-search" class="filter-input" 
                   placeholder="Buscar por tienda, referencia o ID...">
        </div>
        
        <button id="btn-refresh" class="btn-refresh">
            <i class="fas fa-sync-alt"></i> Actualizar
        </button>
    </div>
    
    <!-- Tabla de movimientos -->
    <div class="table-container">
        <table id="tabla-movimientos" class="data-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Fecha</th>
                    <th>Tienda</th>
                    <th>Monto</th>
                    <th>Bolsa Destino</th>
                    <th>Referencia</th>
                    <th>Estado</th>
                </tr>
            </thead>
            <tbody id="tbody-movimientos">
                <tr>
                    <td colspan="7" class="text-center">Cargando movimientos...</td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <!-- Área de depuración - VISIBLE SIEMPRE -->
    <div id="debug-info" style="margin-top: 20px; padding: 10px; background-color: #f8f9fa; border-radius: 5px;">
        <h3>Información de depuración</h3>
        <div>
            <strong>Role:</strong> <span id="debug-role">-</span><br>
            <strong>UID:</strong> <span id="debug-uid">-</span><br>
            <strong>Estado de carga:</strong> <span id="debug-estado">No iniciado</span>
        </div>
        <pre id="debug-content" style="white-space: pre-wrap; font-size: 12px; margin-top: 10px; background: #f0f0f0; padding: 10px; max-height: 300px; overflow: auto;"></pre>
    </div>
</div>

<style>
    /* Estilos para las estadísticas */
    .stats-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        gap: 15px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        transition: transform 0.3s ease;
    }
    
    .stat-card:hover {
        transform: translateY(-5px);
    }
    
    .stat-icon {
        font-size: 2.5em;
        opacity: 0.8;
    }
    
    .stat-content {
        flex: 1;
    }
    
    .stat-value {
        font-size: 1.8em;
        font-weight: bold;
        margin-bottom: 5px;
    }
    
    .stat-label {
        font-size: 0.9em;
        opacity: 0.9;
    }
    
    /* Estilos para filtros */
    .filters-container {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
        align-items: flex-end;
    }
    
    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }
    
    .filter-group label {
        font-size: 0.9em;
        color: #666;
        font-weight: 500;
    }
    
    .filter-select,
    .filter-input {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 14px;
        min-width: 150px;
    }
    
    .btn-refresh {
        padding: 8px 16px;
        background: #4CAF50;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 5px;
        transition: background 0.3s;
    }
    
    .btn-refresh:hover {
        background: #45a049;
    }
    
    /* Estilos para la tabla */
    .table-container {
        overflow-x: auto;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .data-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .data-table thead {
        background-color: #f8f9fa;
    }
    
    .data-table th {
        padding: 12px;
        text-align: left;
        font-weight: 600;
        color: #333;
        border-bottom: 2px solid #dee2e6;
    }
    
    .data-table td {
        padding: 12px;
        border-bottom: 1px solid #dee2e6;
    }
    
    .data-table tbody tr:hover {
        background-color: #f8f9fa;
    }
    
    /* Estilos para estados */
    .estado-badge {
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 0.85em;
        font-weight: 500;
        display: inline-block;
    }
    
    .estado-pendiente {
        background-color: #ffeaa7;
        color: #d63031;
    }
    
    .estado-aprobado {
        background-color: #55efc4;
        color: #00b894;
    }
    
    .estado-rechazado {
        background-color: #fab1a0;
        color: #d63031;
    }
    
    .text-center {
        text-align: center;
    }
    
    .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>

<script>
    // Variables globales
    let movimientosData = [];
    let movimientosFiltrados = [];
    
    // IMPORTANTE: Enviar role="root" siempre, y obtener el UID de la sesión
    const userRole = "root";
    const userUid = sessionStorage.getItem('userUid') || sessionStorage.getItem('userUID') || '';
    
    // Mostrar información de depuración
    document.getElementById('debug-role').textContent = userRole;
    document.getElementById('debug-uid').textContent = userUid || "No encontrado";
    
    console.log('Módulo bolsa_saldo iniciado - Role:', userRole, 'UID:', userUid);
    
    // Función para cargar los movimientos - REESCRITA PARA MAYOR CLARIDAD
    async function cargarMovimientos() {
        document.getElementById('debug-estado').textContent = "Iniciando carga...";
        console.log('Iniciando carga de movimientos...');
        
        try {
            // Construir URL con los parámetros
            const url = `../api/get_movimientos_recarga.php?role=${userRole}&uid=${userUid}`;
            console.log('Llamando a:', url);
            document.getElementById('debug-estado').textContent = "Enviando solicitud...";
            
            // Realizar la solicitud HTTP
            const response = await fetch(url);
            console.log('Response status:', response.status);
            document.getElementById('debug-estado').textContent = `Respuesta recibida: ${response.status}`;
            
            // Obtener el texto de la respuesta
            const responseText = await response.text();
            document.getElementById('debug-content').textContent = responseText;
            
            // Intentar parsear la respuesta como JSON
            let data;
            try {
                data = JSON.parse(responseText);
                document.getElementById('debug-estado').textContent = "JSON parseado correctamente";
            } catch (parseError) {
                console.error('Error parseando JSON:', parseError);
                document.getElementById('debug-estado').textContent = "ERROR: No se pudo parsear JSON";
                throw new Error('Respuesta inválida del servidor: ' + responseText.substring(0, 200));
            }
            
            console.log('Data recibida:', data);
            
            // Verificar si la respuesta es exitosa
            if (data.success) {
                console.log('Movimientos recibidos:', data.movimientos ? data.movimientos.length : 0);
                document.getElementById('debug-estado').textContent = `Éxito: ${data.movimientos ? data.movimientos.length : 0} movimientos recibidos`;
                
                // Guardar los datos y actualizar la interfaz
                movimientosData = data.movimientos || [];
                actualizarEstadisticas(data.estadisticas || {
                    total_recargas: 0,
                    recargas_pendientes: 0,
                    recargas_aprobadas: 0,
                    monto_total: 0
                });
                aplicarFiltros();
            } else {
                console.error('Error en la respuesta:', data);
                document.getElementById('debug-estado').textContent = `ERROR: ${data.error || 'Respuesta sin éxito'}`;
                throw new Error(data.error || 'Error al obtener los datos');
            }
            
        } catch (error) {
            console.error('Error completo:', error);
            document.getElementById('debug-estado').textContent = `ERROR FATAL: ${error.message}`;
            mostrarError('Error al cargar los movimientos: ' + error.message);
        }
    }
    
    // Función para actualizar las estadísticas
    function actualizarEstadisticas(stats) {
        document.getElementById('total-recargas').textContent = stats.total_recargas;
        document.getElementById('recargas-pendientes').textContent = stats.recargas_pendientes;
        document.getElementById('recargas-aprobadas').textContent = stats.recargas_aprobadas;
        document.getElementById('monto-total').textContent = '$' + formatNumber(stats.monto_total);
    }
    
    // Función para aplicar filtros
    function aplicarFiltros() {
        const estado = document.getElementById('filter-estado').value;
        const busqueda = document.getElementById('filter-search').value.toLowerCase();
        
        movimientosFiltrados = movimientosData.filter(mov => {
            let cumple = true;
            
            // Filtro por estado
            if (estado && mov.estado !== estado) {
                cumple = false;
            }
            
            // Filtro por búsqueda
            if (busqueda) {
                const textoCompleto = `${mov.id_movimiento} ${mov.nombre_tienda || ''} ${mov.referencia || ''} ${mov.user_id || ''}`.toLowerCase();
                if (!textoCompleto.includes(busqueda)) {
                    cumple = false;
                }
            }
            
            return cumple;
        });
        
        renderizarTabla();
    }
    
    // Función para renderizar la tabla
    function renderizarTabla() {
        const tbody = document.getElementById('tbody-movimientos');
        
        if (movimientosFiltrados.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center">No se encontraron movimientos</td></tr>';
            return;
        }
        
        tbody.innerHTML = movimientosFiltrados.map(mov => {
            const estadoClass = `estado-${mov.estado}`;
            const bolsaDestino = mov.bolsa_destino_info ? 
                `${mov.bolsa_destino_info.nombre} (${mov.bolsa_destino_info.tienda})` : 
                'N/A';
            
            return `
                <tr>
                    <td>${mov.id_movimiento}</td>
                    <td>${mov.fecha_formateada || new Date(mov.fecha_creacion).toLocaleString()}</td>
                    <td>${mov.nombre_tienda || 'Sin tienda'}</td>
                    <td>${mov.monto_formateado || ('$' + parseFloat(mov.monto).toFixed(2))}</td>
                    <td>${bolsaDestino}</td>
                    <td>${mov.referencia || 'N/A'}</td>
                    <td><span class="estado-badge ${estadoClass}">${mov.estado}</span></td>
                </tr>
            `;
        }).join('');
    }
    
    // Función para formatear números
    function formatNumber(num) {
        return new Intl.NumberFormat('es-MX', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }).format(num);
    }
    
    // Función para mostrar errores
    function mostrarError(mensaje) {
        const tbody = document.getElementById('tbody-movimientos');
        tbody.innerHTML = `<tr><td colspan="7" class="text-center" style="color: red;">${mensaje}</td></tr>`;
    }
    
    // Event listeners
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM cargado - Iniciando módulo...');
        
        // Cargar movimientos inmediatamente sin verificaciones
        cargarMovimientos();
        
        // Configurar event listeners para filtros
        document.getElementById('filter-estado').addEventListener('change', aplicarFiltros);
        document.getElementById('filter-search').addEventListener('input', aplicarFiltros);
        
        // Botón actualizar
        document.getElementById('btn-refresh').addEventListener('click', function() {
            this.querySelector('i').classList.add('fa-spin');
            document.getElementById('debug-estado').textContent = "Actualizando...";
            cargarMovimientos().then(() => {
                this.querySelector('i').classList.remove('fa-spin');
            });
        });
    });
</script>